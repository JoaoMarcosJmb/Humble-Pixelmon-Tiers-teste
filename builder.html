<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Humble Builder - Validator</title>
  <link rel="icon" type="image/png" href="img/mike_anotando2.png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
  <style>
    /* --- VARI√ÅVEIS & RESET --- */
    :root { 
      --cor-dourado: #d1a720; 
      --cor-fundo: #111; 
      --cor-painel: #1a1a1a;
      --cor-texto: #f5f5f5; 
      --cor-input: #2a2a2a; 
      --cor-borda: #444;
    }
    * { box-sizing: border-box; }
    
    body { 
      font-family: "Segoe UI", Arial, sans-serif; 
      background: var(--cor-fundo); 
      margin: 0; padding: 0; 
      color: var(--cor-texto); 
      height: 100vh; 
      overflow: hidden; 
      display: flex; flex-direction: column;
    }
    
    /* --- HEADER --- */
    header { 
      height: 60px; padding: 0 20px; flex-shrink: 0;
      display: flex; justify-content: space-between; align-items: center; 
      background: rgba(20, 20, 20, 0.98); border-bottom: 2px solid var(--cor-dourado); 
      z-index: 1000;
    }
    header h1 { font-size: 1.4rem; color: var(--cor-dourado); display: flex; gap: 10px; margin: 0; align-items: center; }
    header h1 img { height: 35px; }
    header a { text-decoration: none; color: inherit; display:flex; align-items:center; gap:10px; }

    .menu-toggle { display: flex; flex-direction: column; width: 30px; gap: 6px; cursor: pointer; }
    .menu-toggle span { display: block; height: 3px; background: var(--cor-texto); border-radius: 4px; }

    /* --- LAYOUT PRINCIPAL --- */
    .main-container { display: flex; flex-grow: 1; overflow: hidden; width: 100%; }

    /* --- SIDEBAR --- */
    .sidebar {
        width: 300px; background: #181818; border-right: 1px solid #333;
        display: flex; flex-direction: column; flex-shrink: 0;
    }
    .sidebar-header { padding: 15px; border-bottom: 1px solid #333; background: #202020; }
    .btn-new-team {
        width: 100%; padding: 12px; background: #28a745; color: white; border: none; 
        border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem;
    }
    .btn-new-team:hover { background: #218838; }

    .team-list { flex-grow: 1; overflow-y: auto; padding: 10px; }
    .team-list::-webkit-scrollbar { width: 6px; }
    .team-list::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

    .sidebar-card {
        background: #2a2a2a; border: 1px solid #444; border-radius: 6px;
        padding: 10px; margin-bottom: 8px; cursor: pointer; position: relative; transition: 0.2s;
    }
    .sidebar-card:hover { background: #333; border-color: #666; }
    .sidebar-card.active { border-color: var(--cor-dourado); background: #3a3320; }

    .card-title { color: var(--cor-dourado); font-weight: bold; font-size: 0.95rem; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding-right: 20px;}
    .card-meta { color: #888; font-size: 0.75rem; margin-bottom: 6px; }
    .card-icons { display: flex; gap: 2px; height: 25px; overflow: hidden; }
    .card-icons img { width: 30px; height: 25px; object-fit: contain; }
    
    .btn-delete-card {
        position: absolute; top: 5px; right: 5px; background: none; border: none; 
        color: #666; font-size: 1.2rem; cursor: pointer; line-height: 1;
    }
    .btn-delete-card:hover { color: #ff4d4d; }

    /* --- BUILDER AREA --- */
    .builder-area {
        flex-grow: 1;
        background: linear-gradient(135deg, rgba(20,20,20,0.95), rgba(40,30,20,0.95)), 
                    url("https://i.imgur.com/vATNRmF.png");
        background-size: cover; overflow-y: auto; padding: 20px; display: flex; flex-direction: column;
    }
    .builder-wrapper { width: 100%; max-width: 1200px; margin: 0 auto; }

    .toolbar {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
      background: rgba(30,30,30,0.95); padding: 12px 20px; border-radius: 8px; border: 1px solid var(--cor-borda);
      flex-wrap: wrap; gap: 15px; width: 100%;
    }
    .toolbar-left { flex-grow: 1; display:flex; flex-direction:column; gap:5px; } 
    .toolbar-controls { display: flex; gap: 10px; align-items: center; }

    #teamNameInput { 
        background: transparent; border: none; border-bottom: 1px solid #555; 
        color: #fff; font-size: 1.3rem; padding: 2px; width: 100%; 
    }
    #teamNameInput:focus { border-color: var(--cor-dourado); outline: none; }
    
    #teamAuthorInput {
        background: transparent; border: none; border-bottom: 1px solid #444;
        color: #aaa; font-size: 0.9rem; padding: 2px; width: 100%;
    }
    #teamAuthorInput:focus { border-color: var(--cor-dourado); outline: none; color: #fff; }

    .tier-select { background: #111; color: var(--cor-dourado); border: 1px solid #555; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; min-width: 150px; }
    
    .btn-action { background: var(--cor-dourado); border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 4px; color: #111; display:flex; align-items:center; gap:5px; }
    
    .btn-save { background: #28a745; color: #fff; } .btn-save:hover { background: #34ce57; }
    .btn-import { background: #444; color: #fff; border:1px solid #666; } .btn-import:hover { background: #555; }
    .btn-validate { background: #17a2b8; color: #fff; } .btn-validate:hover { background: #1ebcd3; }

    /* TABS */
    .tabs-wrapper { display: flex; align-items: flex-end; gap: 5px; margin-bottom: 0; padding-left: 5px; }
    .tab-slot {
        background: #222; border: 1px solid #444; border-bottom: none; border-radius: 8px 8px 0 0;
        width: 60px; height: 45px; cursor: pointer; display: flex; justify-content: center; align-items: center;
        opacity: 0.6; position: relative; transition: 0.2s;
    }
    .tab-slot.active { opacity: 1; background: rgba(30, 30, 30, 0.95); border-color: var(--cor-dourado); border-bottom: 1px solid rgba(30,30,30,0.95); height: 50px; z-index: 10; margin-bottom: -1px; }
    .tab-icon { width: 35px; height: 35px; object-fit: contain; pointer-events: none; }
    .tab-close { position: absolute; top: 0; right: 3px; font-size: 14px; color: #888; display: none; }
    .tab-slot:hover .tab-close { display: block; cursor: pointer; color: #ff4d4d; }
    
    .add-tab-btn { width: 40px; height: 40px; background: #222; border: 1px dashed #666; border-radius: 8px 8px 0 0; color: #888; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center; }
    .add-tab-btn.hidden { display: none; }

    /* EDITOR */
    .editor-container-wrapper {
        background: rgba(30, 30, 30, 0.95); border: 1px solid var(--cor-dourado); border-radius: 0 8px 8px 8px; 
        padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); min-height: 550px; width: 100%;
    }
    .poke-editor { display: none; width: 100%; }
    .poke-editor.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .header-row { margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
    .header-row h4 { margin: 0; color: var(--cor-dourado); font-size: 1.2rem; }

    .editor-layout { display: flex; gap: 25px; align-items: flex-start; flex-wrap: wrap; }
    .left-panel { display: flex; flex-direction: row; gap: 15px; flex-shrink: 0; }
    .visual-large-box { 
        width: 160px; height: 160px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 12px; 
        display: flex; justify-content: center; align-items: center; flex: none; 
    }
    .poke-sprite-large { width: 130px; height: 130px; object-fit: contain; filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); }

    /* STATS */
    .base-stats-panel { 
        background: rgba(0,0,0,0.2); padding: 12px; border-radius: 8px; border: 1px solid #444; 
        font-size: 0.85rem; flex-grow: 1; min-width: 250px; 
    }
    .stat-bar-row { display: flex; align-items: center; margin-bottom: 5px; gap: 8px; }
    .stat-name { width: 30px; font-weight: bold; color: #888; }
    .stat-val-base { width: 30px; text-align: center; color: #777; font-size: 0.8rem; }
    .stat-val-final { width: 35px; text-align: right; color: #fff; font-weight: bold; }
    .bar-track { flex-grow: 1; background: #222; height: 8px; border-radius: 4px; overflow: hidden; }
    .bar-fill { height: 100%; width: 0%; border-radius: 4px; transition: width 0.3s; }
    .bar-hp { background: #FF5959; } .bar-atk { background: #F5AC78; } .bar-def { background: #FAE078; }
    .bar-spa { background: #9DB7F5; } .bar-spd { background: #A7DB8D; } .bar-spe { background: #FA92B2; }

    .inputs-area { flex-grow: 1; min-width: 400px; display: flex; flex-direction: column; gap: 12px; }
    .row { display: flex; gap: 12px; } .col { flex: 1; } 
    .col-small { width: 90px; flex:none; } 
    .col-mini { width: 85px; flex:none; }

    .input-wrapper { position: relative; width: 100%; }
    .clear-x { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #666; cursor: pointer; display: none; z-index: 5; }
    .clear-x:hover { color: #ff4d4d; }
    .input-wrapper input:not(:placeholder-shown) + .clear-x { display: block; }

    .input-with-icon { display: flex; align-items: center; gap: 8px; width: 100%; }
    .item-icon-img { width: 32px; height: 32px; object-fit: contain; opacity: 0.3; transition: 0.3s; }
    .item-icon-img.active { opacity: 1; }

    label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 3px; }
    input[type="text"], input[type="number"], select {
        background: #252525; border: 1px solid #444; color: #fff;
        padding: 8px 25px 8px 10px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 0.9rem; height: 34px;
    }
    input:focus, select:focus { border-color: var(--cor-dourado); outline: none; background: #303030; }

    .iv-section { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border: 1px solid #444; }
    .iv-grid { display: flex; gap: 10px; justify-content: space-between; }
    .iv-box { text-align: center; width: 100%; }
    .iv-box label { font-size: 0.7rem; color: #666; }
    .iv-box input { text-align: center; font-size: 0.9rem; background: #1a1a1a; padding: 5px; }

    .stats-box { margin-top: 15px; }
    .ev-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: #aaa; }
    .stat-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
    .stat-label { width: 30px; font-weight: bold; font-size: 0.85rem; color: #888; }
    input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: #333; border-radius: 3px; outline: none; flex-grow: 1; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--cor-dourado); border-radius: 50%; cursor: pointer; }
    .ev-num { width: 50px !important; text-align: center; padding: 0 !important; font-size: 0.9rem !important; }

    .move-input { border-left: 4px solid #555 !important; margin-bottom: 8px; height: 38px !important; }
    .move-input:focus { border-left-color: var(--cor-dourado) !important; }

    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: #1a1a1a; border: 2px solid var(--cor-dourado); padding: 20px; border-radius: 10px; width: 90%; max-width: 650px; }
    .modal-textarea { width: 100%; height: 300px; background: #222; color: #fff; border: 1px solid #444; padding: 15px; font-family: monospace; font-size: 0.9rem; resize: vertical; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px; }

    nav { position: absolute; top: 60px; right: 20px; background: rgba(30, 25, 20, 0.98); border: 1px solid var(--cor-dourado); border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.8); display: none; flex-direction: column; padding: 15px; gap: 12px; z-index: 1200; width: 220px; }
    nav.active { display: flex; }
    nav a { color: var(--cor-dourado); text-decoration:none; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:5px; }

/* --- LOGIN INTEGRADO --- */
    .auth-container {
        background: var(--cor-input);
        border: 1px solid var(--cor-borda);
        border-radius: 6px; padding: 12px; margin-bottom: 15px;
        display: flex; flex-direction: column; gap: 8px;
    }
    .auth-header { font-size: 0.8rem; color: #888; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px; text-align: center; }
    .login-input { background: #151515; border: 1px solid #333; color: #ddd; padding: 8px 10px; border-radius: 4px; width: 100%; font-size: 0.85rem; transition: border-color 0.2s; }
    .login-input:focus { border-color: var(--cor-dourado); outline: none; }
    .auth-btn-row { display: flex; gap: 5px; }
    .btn-login { flex: 1; background: var(--cor-dourado); color: #000; font-weight: bold; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    .btn-login:hover { filter: brightness(1.1); }
    .btn-register { flex: 1; background: #333; color: #ccc; border: 1px solid #444; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
    .btn-register:hover { background: #444; color: #fff; }
    .google-btn { width: 100%; background: #222; border: 1px solid #444; color: #eee; padding: 8px; border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.85rem; transition: 0.2s; margin-top: 5px; }
    .google-btn:hover { background: #333; border-color: #666; }
    .google-icon { font-weight: bold; color: #4285F4; font-size: 1.1em; }

    /* --- PERFIL LOGADO --- */
    .user-card { background: linear-gradient(135deg, #222, #1a1a1a); border: 1px solid var(--cor-dourado); border-radius: 6px; padding: 10px; display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #333; object-fit: cover; }
    .user-info { flex-grow: 1; overflow: hidden; }
    .user-name { color: var(--cor-dourado); font-weight: bold; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-email { color: #666; font-size: 0.7rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .btn-logout { background: transparent; border: none; color: #ff5555; font-size: 1.2rem; cursor: pointer; padding: 0 5px; }
    .btn-logout:hover { color: #ff0000; transform: scale(1.1); }
    .btn-share { background: #4a5568; color: #fff; border: 1px solid #718096; }
    .btn-share:hover { background: #2d3748; }
    .btn-publish { background: #805ad5; color: #fff; border: 1px solid #9f7aea; }
    .btn-publish:hover { background: #6b46c1; box-shadow: 0 0 10px rgba(128, 90, 213, 0.4); }
  </style>
</head>
<body>

  <datalist id="list-pokemon"></datalist>
  <datalist id="list-items"></datalist>

  <div class="modal-overlay" id="ioModal">
    <div class="modal-content">
      <h3 style="margin-top:0; color:var(--cor-dourado)">Importar / Exportar (Texto)</h3>
      <textarea id="ioText" class="modal-textarea" spellcheck="false"></textarea>
      <div class="modal-buttons">
        <button class="btn-action" style="background:#444;" onclick="document.getElementById('ioModal').style.display='none'">Fechar</button>
        <button class="btn-action" style="background:#444;" onclick="copyToClipboard()">Copiar</button>
        <button class="btn-action" onclick="processImport()">Carregar</button>
      </div>
    </div>
  </div>

  <header>
    <h1><a href="feed.html"><img src="https://i.imgur.com/XOEcuO8.png"> Humble Builder</a></h1>
    <div class="menu-toggle" id="menuBtn"><span></span><span></span><span></span></div>
  </header>

  <nav id="dropdownMenu">
    <a href="index.html">üè† In√≠cio</a>
    <a href="https://www.humblepixelmon.com.br">üåê Site Oficial</a>
    <a href="Tiers_1.12.html">üó°Ô∏è Tiers 1.12</a>
    <a href="Tiers_1.16.html">üõ°Ô∏è Tiers 1.16</a>
    <a href="notas">üìù Notas de Atualiza√ß√£o</a>
  </nav>

  <div class="main-container">
<aside class="sidebar">
        <div class="sidebar-header">
            
            <div id="auth-section">
                
                <div id="loginForm" class="auth-container">
                    <div class="auth-header">Acesso Humble</div>
                    
                    <input type="email" id="emailInput" class="login-input" placeholder="E-mail">
                    <input type="password" id="passInput" class="login-input" placeholder="Senha">
                    
                    <div class="auth-btn-row">
                        <button id="btnEmailLogin" class="btn-login">Entrar</button>
                        <button id="btnEmailRegister" class="btn-register">Criar</button>
                    </div>

                    <button id="btnGoogleLogin" class="google-btn">
                       <span class="google-icon">G</span> Entrar com Google
                    </button>
                </div>

                <div id="userProfile" class="user-card" style="display:none;">
                    <img id="userPhoto" src="" class="user-avatar">
                    <div class="user-info">
                        <div id="userName" class="user-name">Treinador</div>
                        <div id="userEmail" class="user-email">email@exemplo.com</div>
                    </div>
                    <button id="btnLogout" class="btn-logout" title="Sair">√ó</button>
                </div>

            </div>

            <button class="btn-new-team" onclick="createNewTeam()">
                <span style="font-size:1.1rem; vertical-align:middle; margin-right:5px;">+</span> Novo Time
            </button>
        </div>
        
        <div class="team-list" id="teamListContainer"></div>
    </aside>

    <main class="builder-area">
        <div class="builder-wrapper">
            <div class="toolbar">
                <div class="toolbar-left">
                    <input type="text" id="teamNameInput" maxlength="25" placeholder="Nome do Time" onchange="saveCurrentTeamToStorage()">
                    <input type="text" id="teamAuthorInput" maxlength="16" placeholder="Autor / Nick" onchange="saveCurrentTeamToStorage()">
                </div>
<div class="toolbar-controls">
    <select id="teamTier" class="tier-select" onchange="carregarDados(this.value)">
        <option value="" disabled selected>Selecionar Tier</option>
        <option value="AG">AG</option><option value="LC">LC</option><option value="Monotype">Monotype</option>
        <option value="NU">NU</option><option value="National_Dex">National Dex</option>
        <option value="National_Dex_Monotype">NatDex Monotype</option><option value="National_Dex_RU">NatDex RU</option>
        <option value="National_Dex_UU">NatDex UU</option><option value="National_Dex_Ubers">NatDex Ubers</option>
        <option value="OU">OU</option><option value="PU">PU</option><option value="RU">RU</option>
        <option value="UU">UU</option><option value="Uber">Uber</option><option value="Ubers_UU">Ubers UU</option><option value="ZU">ZU</option>
    </select>
    
    <button class="btn-action btn-share" onclick="shareTeamLink()" title="Gerar Link">üîó Link</button>
    <button class="btn-action btn-publish" onclick="publishTeam()" title="Publicar">üì¢ Publicar</button>
    
    <button class="btn-action btn-validate" onclick="validateTeam()">‚úì Validar</button>
    <button class="btn-action btn-import" onclick="openIOModal()">üì• Texto</button>
    <button class="btn-action btn-save" onclick="saveCurrentTeamToStorage()">üíæ Salvar</button>
</div>
            </div>

            <div class="tabs-wrapper">
                <div id="tabsContainer" style="display:flex; gap:5px;"></div>
                <button id="addSlotBtn" class="add-tab-btn" onclick="addNewSlot()">+</button>
            </div>

            <div class="editor-container-wrapper" id="editorsContainer"></div>
        </div>
    </main>
  </div>

<script>
    /* --- CONFIGURA√á√ïES GERAIS --- */
    const menuBtn = document.getElementById("menuBtn");
    const dropdownMenu = document.getElementById("dropdownMenu");
    
    menuBtn.addEventListener("click", () => { 
        menuBtn.classList.toggle("active"); 
        dropdownMenu.classList.toggle("active"); 
    });
    document.addEventListener("click", (e) => {
      if (!dropdownMenu.contains(e.target) && !menuBtn.contains(e.target)) {
        menuBtn.classList.remove("active"); dropdownMenu.classList.remove("active");
      }
    });

    const MAX_EVS = 508; 
    const MAX_SLOTS = 6;
    const STATS = ['HP', 'Atk', 'Def', 'SpA', 'SpD', 'Spe'];
    
    const NATURES_INFO = { 
        "Adamant": "+Atk, -SpA", "Bashful": "Neutral", "Bold": "+Def, -Atk", 
        "Brave": "+Atk, -Spe", "Calm": "+SpD, -Atk", "Careful": "+SpD, -SpA", 
        "Docile": "Neutral", "Gentle": "+SpD, -Def", "Hardy": "Neutral", 
        "Hasty": "+Spe, -Def", "Impish": "+Def, -SpA", "Jolly": "+Spe, -SpA", 
        "Lax": "+Def, -SpD", "Lonely": "+Atk, -Def", "Mild": "+SpA, -Def", 
        "Modest": "+SpA, -Atk", "Naive": "+Spe, -SpD", "Naughty": "+Atk, -SpD", 
        "Quiet": "+SpA, -Spe", "Quirky": "Neutral", "Rash": "+SpA, -SpD", 
        "Relaxed": "+Def, -Spe", "Sassy": "+SpD, -Spe", "Serious": "Neutral", 
        "Timid": "+Spe, -Atk" 
    };

    const POKEAPI_IMG = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/";
    const IMG_ERROR = "https://img.pokemondb.net/sprites/items/poke-ball.png"; 
    const ITEM_ICON_BASE = "https://play.pokemonshowdown.com/sprites/itemicons/";

    // --- VARI√ÅVEIS GLOBAIS ---
    let pokemonIdMap = {}; 
    let validAbilitiesMap = {}; 
    let validMovesMap = {}; 
    let todosItens = [];
    let todosMoves = []; // VAI RECEBER O JSON
    let MOVES_MAP = {};  // VAI SER O √çNDICE
    let slotCounter = 0; 
    let slotBaseStats = {}; 
    let allTeams = []; 
    let currentTeamIndex = null;

    // --- LISTA DE MOVES CUSTOMIZADOS (GOLPES EXTRAS) ---
    // Adicione aqui: "Nome do Pokemon": ["Golpe 1", "Golpe 2"]
    const CUSTOM_MOVES = {
        "Deoxys-Speed": ["Spikes"],
        "medicham": ["Fake Out"]
    };

    // --- LISTA DE PALAVRAS PROIBIDAS ---
    const BAD_WORDS = [
        "puta", "puto", "pu.ta", "p.uta", "p4ta", "put4", "put@", "vagabunda", "vagaba", "rapariga", "piranha",
        "merda", "m3rda", "bosta", "cagar", "cagado",
        "caralho", "krl", "carai", "caraio", "c4ralho", "pqp",
        "boceta", "buceta", "bct", "buc3ta", "b0ceta", "xereca", "xoxota", "ppk", "pepeca", "xrk",
        "viado", "v1ado", "viad0", "bixa", "bicha", "boiola", "baitola", "biba", "viadinho", "gayzista",
        "fuder", "foder", "fudido", "fudida", "fodido", "f0der", "fud3r", "foda", "foda-se",
        "pau", "pinto", "piroca", "pica", "rolan", "rola", "penis", "p1nto", "p1roca", "ereto", "gozo", "gozar", "gozada", "gozeidinha", "sperma", "porra", "p0rra",
        "cu", "c.u", "c*", "anus", "anal", "furico", "arrombado", "arrombada",
        "boquete", "boqueteiro", "boqueteira", "chupa", "chupei", "mamada", "mamar",
        "sexo", "sex", "s3x", "transar", "trepar", "suruba", "orgia", "estupro", "abuso", "abusado", "molestado", "pedofilo", "pedofilia", "zoofilo", "zoofilia", "zoofililo", "d.dirry",
        "jack", "estuprador", 
        "corno", "c0rno", "cornudo", "chifrudo", "chuca", "xuca", "x4ca", "ch4ca", "retardado", "autista", "prostituta",
        "preto", "negro", "neguim", "neguinho", "criolo", "crioulo", "macaco", "macaca", "m4caco", "m4caca", "escravo", "senzala",
        "hitler", "h1tler", "nazista", "nazi", "ritler", "suastica", "ariano",
        "judeu", "judiaria", 
        "nigga", "nigger", 
        "traveco", "travesti", "tr4veco", "shemale", "femboy", "tomboy",
        "fuck", "fck", "dick", "pussy", "asshole", "bitch", "shit", "cunt", "whore", "cock", "suck"
    ];

    function normalizeText(text) {
        if (!text) return "";
        return text.toLowerCase()
            .normalize('NFD').replace(/[\u0300-\u036f]/g, "") 
            .replace(/0/g, "o").replace(/1/g, "i").replace(/3/g, "e").replace(/4/g, "a")
            .replace(/5/g, "s").replace(/@/g, "a").replace(/\$/g, "s").replace(/\./g, "")   
            .replace(/\s+/g, ""); 
    }

    function hasProfanity(text) {
        if (!text) return false;
        const lowerText = text.toLowerCase();
        const cleanText = normalizeText(text);
        return BAD_WORDS.some(word => {
            return lowerText.includes(word) || cleanText.includes(word);
        });
    }

    // --- FORMATA√á√ÉO GERAL DE TEXTO ---
    function formatText(str) { 
        if (!str) return ''; 
        // Separa por h√≠fen, capitaliza cada palavra e junta com espa√ßo
        return str.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); 
    }

    // --- CARREGAMENTO E LIMPEZA AUTOM√ÅTICA DO MOVES.JSON ---
    async function initMoves() {
        // Lista de Exce√ß√µes: Golpes que DEVEM manter o h√≠fen
        const EXCEPTIONS = {
            "u-turn": "U-turn",
            "v-create": "V-create",
            "will-o-wisp": "Will-O-Wisp",
            "soft-boiled": "Soft-Boiled",
            "double-edge": "Double-Edge",
            "freeze-dry": "Freeze-Dry",
            "x-scissor": "X-Scissor",
            "lock-on": "Lock-On",
            "self-destruct": "Self-Destruct",
            "trick-or-treat": "Trick-or-Treat",
            "baby-doll-eyes": "Baby-Doll Eyes",
            "topsy-turvy": "Topsy-Turvy",
            "multi-attack": "Multi-Attack",
            "power-up-punch": "Power-Up Punch",
            "wake-up-slap": "Wake-Up Slap",
            "mud-slap": "Mud-Slap"
        };

        const paths = ['builder/moves.json', 'moves.json']; 
        let loaded = false;

        for (const path of paths) {
            try {
                const r = await fetch(path);
                if (r.ok) {
                    const rawData = await r.json();
                    
                    // --- O PULO DO GATO: LIMPAR OS NOMES AQUI ---
                    todosMoves = rawData.map(m => {
                        let prettyName = m.name;
                        const lowerName = m.name.toLowerCase();

                        // 1. Se estiver na lista de exce√ß√µes, usa ela (ex: u-turn -> U-turn)
                        if (EXCEPTIONS[lowerName]) {
                            prettyName = EXCEPTIONS[lowerName];
                        } 
                        // 2. Se n√£o, tira os tra√ßos e deixa Mai√∫scula (ex: fake-out -> Fake Out)
                        else if (m.name.includes('-')) {
                            prettyName = formatText(m.name);
                        }

                        // Retorna o objeto com o nome corrigido para a mem√≥ria
                        return { ...m, name: prettyName };
                    });

                    loaded = true;
                    console.log(`Moves carregados e formatados de: ${path}`);
                    
                    // Recria o Mapa de Busca com os nomes j√° bonitos
                    MOVES_MAP = {};
                    todosMoves.forEach(move => {
                        // Chave limpa para facilitar a busca (sem tra√ßos, sem espa√ßos)
                        // ex: "fake-out", "Fake Out", "fake out" -> "fakeout"
                        const key = move.name.toLowerCase().replace(/[^a-z0-9]/g, '');
                        MOVES_MAP[key] = move;
                    });

                    break;
                }
            } catch (e) { console.log(`Tentando pr√≥ximo caminho...`); }
        }

        if (!loaded) {
            console.error("ERRO: moves.json n√£o encontrado.");
            alert("N√£o foi poss√≠vel carregar a lista de golpes (moves.json). Verifique se o arquivo est√° na pasta 'builder/'.");
        }
    }

    // --- FUN√á√ÉO INTELIGENTE DE NOME DE GOLPE (USANDO O JSON) ---
    function formatMoveName(apiSlug) {
        if (!apiSlug) return "";
        
        // 1. Limpa o nome que vem da API (ex: "u-turn" -> "uturn")
        const cleanKey = apiSlug.toLowerCase().replace(/[^a-z0-9]/g, '');

        // 2. Busca no nosso banco de dados carregado e formatado
        if (MOVES_MAP[cleanKey]) {
            return MOVES_MAP[cleanKey].name; // Retorna "Fake Out" ou "U-turn" perfeito
        }

        // 3. Fallback se n√£o tiver no JSON
        return formatText(apiSlug);
    }

    // --- FORMATADORES ---
    function formatToApiName(name) { 
        if(!name) return "";
        return name.trim().toLowerCase().replace(/ /g, '-').replace(/\./g, '').replace(/'/g, '').replace(/:/g, '').replace(/‚ôÄ/g, '-f').replace(/‚ôÇ/g, '-m'); 
    }
    function formatItemToShowdown(name) { return name.toLowerCase().replace(/[^a-z0-9]/g, ''); }

    // --- INICIALIZA√á√ÉO (COM LEITURA DE LINK) ---
    window.onload = async function() { 
        await initItens(); 
        await initMoves(); // CARREGA OS MOVES
        
        const params = new URLSearchParams(window.location.search);
        const importData = params.get('import');

        if(importData) {
            try {
                const decodedText = decodeURIComponent(escape(atob(importData)));
                document.getElementById('ioText').value = decodedText;
                setTimeout(() => {
                    processImport(); 
                    window.history.replaceState({}, document.title, window.location.pathname);
                    alert("Time carregado via Link Compartilhado!");
                }, 500);
            } catch(e) {
                console.error(e);
                alert("Link inv√°lido ou corrompido.");
                loadAllTeams();
            }
        } else {
            loadAllTeams();
            if(allTeams.length > 0) editTeam(0); 
            else createNewTeam();
        }
    };

    async function initItens() {
        try { 
            const r = await fetch('builder/itens.json'); 
            if (r.ok) { todosItens = await r.json(); atualizarListaItens(null); } 
        } catch (e) { console.warn("Erro itens", e); }
    }

    // --- GERENCIAMENTO DE TIMES ---
    function loadAllTeams() {
        const data = localStorage.getItem('humbleTeamsList');
        if (data) allTeams = JSON.parse(data); else allTeams = [];
        renderSidebar();
    }

    function renderSidebar() {
        const container = document.getElementById('teamListContainer');
        container.innerHTML = "";
        allTeams.forEach((team, index) => {
            const div = document.createElement('div');
            div.className = `sidebar-card ${currentTeamIndex === index ? 'active' : ''}`;
            div.onclick = (e) => { if(!e.target.closest('.btn-delete-card')) editTeam(index); };
            
            let iconsHtml = '';
            if(team.slots) {
                team.slots.slice(0,6).forEach(s => {
                    if(s.name) {
                        const apiName = formatToApiName(s.name);
                        let src = `${POKEAPI_IMG}${apiName}.png`;
                        if(pokemonIdMap[apiName] && typeof pokemonIdMap[apiName] !== 'boolean') {
                            src = `${POKEAPI_IMG}${pokemonIdMap[apiName]}.png`;
                        }
                        iconsHtml += `<img src="${src}" onerror="this.src='${IMG_ERROR}'">`;
                    }
                });
            }
            div.innerHTML = `<div class="card-title">${team.title || 'Novo Time'}</div><div class="card-meta">[${team.tier || 'Format'}]</div><div class="card-icons">${iconsHtml}</div><button class="btn-delete-card" onclick="deleteTeam(${index}, event)">√ó</button>`;
            container.appendChild(div);
        });
    }

    function createNewTeam() {
        currentTeamIndex = null;
        document.getElementById('teamNameInput').value = "";
        document.getElementById('teamAuthorInput').value = "";
        document.getElementById('teamTier').value = "";
        resetBuilderUI();
        addNewSlot(); 
        renderSidebar();
    }

    function resetBuilderUI() {
        document.getElementById('tabsContainer').innerHTML = "";
        document.getElementById('editorsContainer').innerHTML = "";
        slotCounter = 0; slotBaseStats = {};
        validAbilitiesMap = {};
        validMovesMap = {};
    }

    async function editTeam(index) {
        currentTeamIndex = index;
        const team = allTeams[index];
        renderSidebar(); 
        document.getElementById('teamNameInput').value = team.title || "";
        document.getElementById('teamAuthorInput').value = team.author || ""; 
        document.getElementById('teamTier').value = team.tier || "";
        
        await carregarDados(team.tier); 

        resetBuilderUI();

        if (team.slots && team.slots.length > 0) {
            for (const s of team.slots) {
                const id = addNewSlot();
                const ed = document.getElementById(`editor-${id}`);
                ed.querySelector('.p-name').value = s.name;
                
                await updatePokemon(id, ed.querySelector('.p-name'), true); 
                
                ed.querySelector('.p-item').value = s.item;
                updateItemIcon(id, ed.querySelector('.p-item'));
                if(s.ability) ed.querySelector('.p-ability').value = s.ability;
                ed.querySelector('.p-nature').value = s.nature;
                ed.querySelector('.p-level').value = s.level;
                ed.querySelector('.p-gender').value = s.gender || '-';
                ed.querySelector('.p-shiny').value = s.shiny || 'No';
                
                STATS.forEach(stat => {
                    updateEV(id, stat, s.evs[stat] || 0);
                    ed.querySelector(`.p-iv-${stat.toLowerCase()}`).value = s.ivs[stat] || 31;
                });
                const movesInp = ed.querySelectorAll('.p-move');
                s.moves.forEach((m, i) => { if(movesInp[i]) movesInp[i].value = m; });
                
                recalcStats(id);
            }
            switchTab(1);
        } else { addNewSlot(); }
    }

    function saveCurrentTeamToStorage() {
        const authorInput = document.getElementById('teamAuthorInput');
        const authorName = authorInput ? authorInput.value : "";

        const teamData = {
            title: document.getElementById('teamNameInput').value || "Novo Time",
            author: authorName, 
            tier: document.getElementById('teamTier').value,
            slots: []
        };
        document.querySelectorAll('.poke-editor').forEach(ed => {
            const id = ed.id.split('-')[1];
            const name = ed.querySelector('.p-name').value;
            const slot = {
                name: name,
                item: ed.querySelector('.p-item').value,
                ability: ed.querySelector('.p-ability').value,
                nature: ed.querySelector('.p-nature').value,
                level: ed.querySelector('.p-level').value,
                gender: ed.querySelector('.p-gender').value,
                shiny: ed.querySelector('.p-shiny').value,
                evs: {}, ivs: {}, moves: []
            };
            STATS.forEach(s => {
                slot.evs[s] = document.getElementById(`num-${id}-${s}`).value;
                slot.ivs[s] = ed.querySelector(`.p-iv-${s.toLowerCase()}`).value;
            });
            ed.querySelectorAll('.p-move').forEach(m => slot.moves.push(m.value));
            teamData.slots.push(slot);
        });

        if (currentTeamIndex === null) { allTeams.push(teamData); currentTeamIndex = allTeams.length - 1; } 
        else { allTeams[currentTeamIndex] = teamData; }
        localStorage.setItem('humbleTeamsList', JSON.stringify(allTeams));
        renderSidebar();
    }

    function deleteTeam(index, event) {
        if(event) event.stopPropagation();
        if(confirm("Tem certeza que deseja deletar?")) {
            allTeams.splice(index, 1);
            localStorage.setItem('humbleTeamsList', JSON.stringify(allTeams));
            if (currentTeamIndex === index) createNewTeam();
            else if (currentTeamIndex > index) currentTeamIndex--;
            loadAllTeams();
        }
    }

    async function carregarDados(tier) { 
        if(!tier) return;
        const isLC = (tier === 'LC');
        
        document.querySelectorAll('.p-level').forEach(input => {
            if(isLC) { input.max = 5; if(input.value > 5 || input.value == 100) input.value = 5; } 
            else { input.max = 100; if(input.value == 5) input.value = 100; }
            const id = input.closest('.poke-editor').id.split('-')[1];
            recalcStats(id);
        });

        const dl = document.getElementById('list-pokemon'); dl.innerHTML = "";
        pokemonIdMap = {}; 
        
        // --- ESTRAT√âGIA DE FUNDIR JSONs ---
        let arquivosParaCarregar = [`tiers_1.16/${tier}.json`];

        if (tier.startsWith('National_Dex') && tier !== 'National_Dex') {
            arquivosParaCarregar.unshift('tiers_1.16/National_Dex.json');
        }

        let dadosFundidos = {};

        try {
            for (const arq of arquivosParaCarregar) {
                const r = await fetch(arq);
                if (r.ok) {
                    const d = await r.json();
                    Object.assign(dadosFundidos, d);
                }
            }

            Object.keys(dadosFundidos).forEach(chaveJson => {
                const nomeExibicao = formatText(chaveJson);
                const o = document.createElement('option'); 
                o.value = nomeExibicao; 
                dl.appendChild(o);
                const chaveNormalizada = formatToApiName(chaveJson);
                if(dadosFundidos[chaveJson].id) {
                    pokemonIdMap[chaveNormalizada] = dadosFundidos[chaveJson].id; 
                } else {
                    pokemonIdMap[chaveNormalizada] = true;
                }
            });

        } catch(e){ 
            console.error("Erro ao carregar Tier Local", e); 
            alert("Erro ao carregar lista de Pok√©mon.");
        }
        atualizarListaItens(tier);
    }
    
    function atualizarListaItens(tier) {
        const dl = document.getElementById('list-items'); dl.innerHTML = "";
        todosItens.forEach(i => {
            if(tier && i.ban && i.ban.includes(tier)) return;
            const o = document.createElement('option'); o.value = i.name; dl.appendChild(o);
        });
    }
    
    function validateTeam(silent = false) {
        const tier = document.getElementById('teamTier').value;
        const teamName = document.getElementById('teamNameInput').value;
        const authorName = document.getElementById('teamAuthorInput').value;

        if(!tier) { if(!silent) alert("Selecione uma Tier."); return false; }
        
        if (hasProfanity(teamName) || hasProfanity(authorName)) {
            alert("O nome do time ou do autor cont√©m termos ofensivos/proibidos.\nPor favor, altere para continuar.");
            return false;
        }

        let errors = [];
        document.querySelectorAll('.poke-editor').forEach((ed, i) => {
            const id = ed.id.split('-')[1];
            const name = ed.querySelector('.p-name').value.trim();
            
            if(name) {
                const searchName = formatToApiName(name);
                if(!pokemonIdMap[searchName]) errors.push(`#${i+1} ${name}: N√£o permitido em ${tier} ou nome incorreto.`);
                
                const item = ed.querySelector('.p-item').value.trim();
                const itemObj = todosItens.find(it => it.name === item);
                if(itemObj && itemObj.ban && itemObj.ban.includes(tier)) errors.push(`#${i+1} ${name}: Item (${item}) banido em ${tier}.`);

                const ability = ed.querySelector('.p-ability').value.trim();
                if (validAbilitiesMap[id]) {
                    if (!ability) errors.push(`#${i+1} ${name}: Precisa de uma habilidade.`);
                    else if (!validAbilitiesMap[id].includes(ability)) errors.push(`#${i+1} ${name}: Habilidade "${ability}" inv√°lida.`);
                }

                // --- VALIDA√á√ÉO DE MOVES ---
                const moveInputs = ed.querySelectorAll('.p-move');
                const allowedMoves = validMovesMap[id];
                
                moveInputs.forEach((inp, mIndex) => {
                    const moveVal = inp.value.trim();
                    if (moveVal) {
                        if (allowedMoves && !allowedMoves.includes(moveVal)) {
                            if (!moveVal.startsWith("Hidden Power")) { 
                                errors.push(`#${i+1} ${name}: N√£o aprende o movimento "${moveVal}".`);
                            }
                        }
                    }
                });
            }
        });

        if(errors.length > 0) {
            alert("Erros encontrados:\n\n" + errors.join("\n"));
            return false;
        } else {
            if(!silent) alert("Time V√°lido!");
            return true;
        }
    }

    function addNewSlot() {
        if (document.querySelectorAll('.tab-slot').length >= MAX_SLOTS) return;
        slotCounter++; const id = slotCounter;
        const tab = document.createElement('div'); tab.className='tab-slot'; tab.id=`tab-${id}`; tab.onclick=()=>switchTab(id);
        tab.innerHTML = `<span class="tab-close" onclick="removeSlot(${id}, event)">√ó</span><img src="${IMG_ERROR}" id="tab-img-${id}" class="tab-icon">`;
        document.getElementById('tabsContainer').appendChild(tab);
        const ed = document.createElement('div'); ed.className='poke-editor'; ed.id=`editor-${id}`; ed.innerHTML=generateEditorHTML(id);
        document.getElementById('editorsContainer').appendChild(ed);
        
        const tier = document.getElementById('teamTier').value;
        if(tier === 'LC') { 
            ed.querySelector('.p-level').value = 5; 
            ed.querySelector('.p-level').max = 5; 
        }

        slotBaseStats[id] = {hp:0,atk:0,def:0,spa:0,spd:0,spe:0};
        switchTab(id);
        updateAddBtnVisibility();
        return id;
    }
    
    function removeSlot(id,e){ 
        if(e)e.stopPropagation(); 
        const tab = document.getElementById(`tab-${id}`);
        const wasActive = tab.classList.contains('active');
        document.getElementById(`tab-${id}`).remove(); document.getElementById(`editor-${id}`).remove(); 
        delete slotBaseStats[id];
        delete validAbilitiesMap[id];
        if (wasActive) {
            const tabs = document.querySelectorAll('.tab-slot');
            if(tabs.length > 0) switchTab(tabs[tabs.length-1].id.split('-')[1]);
            else addNewSlot();
        }
        updateAddBtnVisibility();
        saveCurrentTeamToStorage();
    }
    function switchTab(id){ document.querySelectorAll('.tab-slot').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.poke-editor').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-${id}`)?.classList.add('active'); document.getElementById(`editor-${id}`)?.classList.add('active'); }
    function updateAddBtnVisibility(){ document.getElementById('addSlotBtn').classList.toggle('hidden', document.querySelectorAll('.tab-slot').length >= MAX_SLOTS); }

    function generateEditorHTML(id) {
        const nOpts = Object.keys(NATURES_INFO).map(n=>`<option value="${n}">${n}</option>`).join('');
        return `<div class="editor-layout"><div class="left-panel"><div class="visual-large-box"><img src="${IMG_ERROR}" id="img-${id}" class="poke-sprite-large"></div><div class="base-stats-panel" id="stats-panel-${id}">${STATS.map(s=>`<div class="stat-bar-row"><span class="stat-name">${s}</span><span class="stat-val-base" id="base-${id}-${s.toLowerCase()}">0</span><div class="bar-track"><div class="bar-fill bar-${s.toLowerCase()}" id="bar-${id}-${s.toLowerCase()}"></div></div><span class="stat-val-final" id="val-${id}-${s.toLowerCase()}">0</span></div>`).join('')}</div></div><div class="inputs-area"><div class="row"><div class="col"><label>Pok√©mon</label><input type="text" class="p-name" list="list-pokemon" onchange="updatePokemon('${id}',this,true);saveCurrentTeamToStorage()"></div><div class="col"><label>Item</label><div class="input-wrapper"><input type="text" class="p-item" list="list-items" oninput="updateItemIcon('${id}',this);saveCurrentTeamToStorage()"><span class="clear-x" onclick="clearItem('${id}')">√ó</span></div><img id="item-icon-${id}" class="item-icon-img" style="position:absolute; right:35px; top:32px;"></div></div><div class="row"><datalist id="abilities-${id}"></datalist><div class="col"><label>Ability</label><input type="text" class="p-ability" list="abilities-${id}" onchange="saveCurrentTeamToStorage()"></div><div class="col"><label>Nature</label><select class="p-nature" onchange="recalcStats('${id}');saveCurrentTeamToStorage()"><option value="" disabled>Nature</option>${nOpts}</select></div><div class="col-small"><label>Level</label><input type="number" class="p-level" value="100" onchange="recalcStats('${id}');saveCurrentTeamToStorage()"></div><div class="col-mini"><label>Gender</label><select class="p-gender" onchange="saveCurrentTeamToStorage()"><option value="-">-</option><option value="M">M</option><option value="F">F</option></select></div><div class="col-mini"><label>Shiny</label><select class="p-shiny" onchange="saveCurrentTeamToStorage()"><option value="No">No</option><option value="Yes">Yes</option></select></div></div><div class="iv-section"><div class="iv-grid">${STATS.map(s=>`<div class="iv-box"><label>${s}</label><input type="text" class="p-iv-${s.toLowerCase()}" value="31" onchange="recalcStats('${id}');saveCurrentTeamToStorage()"></div>`).join('')}</div></div></div></div><div class="stats-box"><div class="ev-header"><span>EVs</span><span id="remain-${id}" class="ev-remaining">508</span></div>${STATS.map(s=>`<div class="stat-row"><span class="stat-label">${s}</span><input type="range" min="0" max="252" oninput="updateEV('${id}','${s}',this.value)" id="range-${id}-${s}"><input type="number" class="ev-num" min="0" max="252" onchange="updateEV('${id}','${s}',this.value)" id="num-${id}-${s}"></div>`).join('')}</div><datalist id="moves-${id}"></datalist><div style="margin-top:20px;"><div class="input-wrapper" style="margin-bottom:8px;"><input type="text" class="move-input p-move" list="moves-${id}" placeholder="- Move 1" onchange="saveCurrentTeamToStorage()"><span class="clear-x" onclick="clearInput(this)">√ó</span></div><div class="input-wrapper" style="margin-bottom:8px;"><input type="text" class="move-input p-move" list="moves-${id}" placeholder="- Move 2" onchange="saveCurrentTeamToStorage()"><span class="clear-x" onclick="clearInput(this)">√ó</span></div><div class="input-wrapper" style="margin-bottom:8px;"><input type="text" class="move-input p-move" list="moves-${id}" placeholder="- Move 3" onchange="saveCurrentTeamToStorage()"><span class="clear-x" onclick="clearInput(this)">√ó</span></div><div class="input-wrapper"><input type="text" class="move-input p-move" list="moves-${id}" placeholder="- Move 4" onchange="saveCurrentTeamToStorage()"><span class="clear-x" onclick="clearInput(this)">√ó</span></div></div>`;
    }

    function clearItem(id) { const i=document.getElementById(`editor-${id}`).querySelector('.p-item'); i.value=""; updateItemIcon(id,i); saveCurrentTeamToStorage(); }
    function clearInput(btn) { btn.previousElementSibling.value=""; saveCurrentTeamToStorage(); }

    async function updatePokemon(id, el, fetchData = true) {
        if (el.value) {
            el.value = el.value.toLowerCase().replace(/(?:^|\s|-)\S/g, function(a) { return a.toUpperCase(); });
        }

        const val = el.value; 
        if(val.length < 2) return;
        
        const apiName = formatToApiName(val);
        const img = document.getElementById(`img-${id}`); 
        const tabImg = document.getElementById(`tab-img-${id}`);
        
        if(!fetchData) {
            let src = `${POKEAPI_IMG}${apiName}.png`;
            if(pokemonIdMap[apiName] && typeof pokemonIdMap[apiName] !== 'boolean') {
                 src = `${POKEAPI_IMG}${pokemonIdMap[apiName]}.png`;
            }
            img.src = src;
            tabImg.src = src;
            return;
        }

        try {
            const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${apiName}`);
            
            if(r.ok) {
                const d = await r.json();
                
                const newSrc = `${POKEAPI_IMG}${d.id}.png`;
                img.src = newSrc; 
                tabImg.src = newSrc;

                slotBaseStats[id] = { hp:d.stats[0].base_stat, atk:d.stats[1].base_stat, def:d.stats[2].base_stat, spa:d.stats[3].base_stat, spd:d.stats[4].base_stat, spe:d.stats[5].base_stat };
                recalcStats(id);
                
                const abilList = document.getElementById(`abilities-${id}`); 
                abilList.innerHTML="";
                const currentAbilityInput = document.getElementById(`editor-${id}`).querySelector('.p-ability');
                
                let allowedAbilities = [];
                d.abilities.forEach(a => { 
                    const formattedAbi = formatText(a.ability.name);
                    allowedAbilities.push(formattedAbi);
                    const o = document.createElement('option'); 
                    o.value = formattedAbi; 
                    abilList.appendChild(o); 
                });
                validAbilitiesMap[id] = allowedAbilities; 

                if (!allowedAbilities.includes(currentAbilityInput.value)) {
                    currentAbilityInput.value = allowedAbilities[0] || "";
                }
                
                // --- MOVES: Carrega moves usando a formata√ß√£o correta ---
                const moveList = document.getElementById(`moves-${id}`); 
                moveList.innerHTML="";
                let allowedMoves = []; 
                
                d.moves.forEach(m => { 
                    // USA A FUN√á√ÉO formatMoveName QUE L√ä O JSON
                    const mName = formatMoveName(m.move.name); 
                    
                    allowedMoves.push(mName); 
                    const o = document.createElement('option'); 
                    o.value = mName; 
                    moveList.appendChild(o); 
                });

                // --- ADICIONA MOVES CUSTOMIZADOS (DA LISTA CUSTOM_MOVES) ---
                if (CUSTOM_MOVES[apiName]) {
                    CUSTOM_MOVES[apiName].forEach(extraMove => {
                        if (!allowedMoves.includes(extraMove)) {
                            allowedMoves.push(extraMove);
                            const o = document.createElement('option');
                            o.value = extraMove;
                            moveList.appendChild(o);
                        }
                    });
                }

                validMovesMap[id] = allowedMoves; 
            }
        } catch(e){
            console.error("Erro API", e);
        }
    }

    function updateItemIcon(id, input) {
        const val = input.value;
        const icon = document.getElementById(`item-icon-${id}`);
        if (!val || val.length < 2) { icon.src=""; icon.classList.remove('active'); return; }
        icon.src = `${ITEM_ICON_BASE}${formatItemToShowdown(val)}.png`;
        icon.classList.add('active');
        icon.onerror = function() { this.src=""; this.classList.remove('active'); }
    }

    function updateEV(id, stat, val) {
        let v = parseInt(val) || 0;
        if (v < 0) v = 0; 
        let usedByOthers = 0;
        STATS.forEach(s => {
            if (s !== stat) {
                usedByOthers += parseInt(document.getElementById(`num-${id}-${s}`).value) || 0;
            }
        });
        const remainingGlobal = 508 - usedByOthers;
        const maxAllowed = Math.min(252, remainingGlobal);
        if (v > maxAllowed) v = maxAllowed;
        document.getElementById(`range-${id}-${stat}`).value = v;
        document.getElementById(`num-${id}-${stat}`).value = v;
        document.getElementById(`remain-${id}`).innerText = "Restam: " + (508 - (usedByOthers + v));
        recalcStats(id);
        saveCurrentTeamToStorage();
    }

    function recalcStats(id) {
        const base = slotBaseStats[id] || {hp:0,atk:0,def:0,spa:0,spd:0,spe:0};
        const level = parseInt(document.getElementById(`editor-${id}`).querySelector('.p-level').value) || 100;
        const nature = document.getElementById(`editor-${id}`).querySelector('.p-nature').value;
        
        let mods = { atk:1, def:1, spa:1, spd:1, spe:1 };

        if(NATURES_INFO[nature] && NATURES_INFO[nature]!=="Neutral") {
            const parts = NATURES_INFO[nature].split(','); 
            parts.forEach(p => { 
                p = p.trim(); 
                const type = p.substring(1).toLowerCase(); 
                if(p.startsWith('+')) mods[type] = 1.1; 
                if(p.startsWith('-')) mods[type] = 0.9; 
            });
        }

        STATS.forEach(s => {
            const k = s.toLowerCase(); const b = base[k];
            document.getElementById(`base-${id}-${k}`).innerText = b;
            
            const iv = parseInt(document.getElementById(`editor-${id}`).querySelector(`.p-iv-${k}`).value)||0;
            const ev = parseInt(document.getElementById(`num-${id}-${s}`).value)||0; 
            
            let final = 0;
            if(b > 0) {
                if(s === 'HP') {
                    final = b === 1 ? 1 : Math.floor(((2 * b + iv + Math.floor(ev / 4)) * level) / 100) + level + 10;
                } else {
                    const rawStat = Math.floor(((2 * b + iv + Math.floor(ev / 4)) * level) / 100) + 5;
                    final = Math.floor(rawStat * mods[k]);
                }
            }
            
            document.getElementById(`val-${id}-${k}`).innerText = final;
            document.getElementById(`bar-${id}-${k}`).style.width = Math.min((b/255)*100, 100)+"%";
        });
    }

    function getTeamAsText() {
        let txt = ""; 
        const tier = document.getElementById('teamTier').value;
        const authorInput = document.getElementById('teamAuthorInput');
        const author = authorInput ? authorInput.value : "";

        if(tier) txt += `=== [Gen 9] ${tier} ===\n`;
        if(author) txt += `// Author: ${author}\n\n`;
        else txt += `\n`;
        
        document.querySelectorAll('.poke-editor').forEach(ed=>{
            const name = ed.querySelector('.p-name').value;
            if(name) {
                let line1 = name;
                const gender = ed.querySelector('.p-gender').value;
                const item = ed.querySelector('.p-item').value;
                if(gender !== '-') line1 += ` (${gender})`;
                if(item) line1 += ` @ ${item}`;
                txt += `${line1}\n`;
                const ability = ed.querySelector('.p-ability').value; if(ability) txt += `Ability: ${ability}\n`;
                const shiny = ed.querySelector('.p-shiny').value; if(shiny === 'Yes') txt += `Shiny: Yes\n`;
                const level = ed.querySelector('.p-level').value; if(level && level!=100) txt += `Level: ${level}\n`;
                
                let evs = []; 
                STATS.forEach(s => { 
                    const id = ed.id.split('-')[1];
                    const v = document.getElementById(`num-${id}-${s}`).value; 
                    if(v > 0) evs.push(`${v} ${s}`); 
                });
                if(evs.length) txt += `EVs: ${evs.join(' / ')}\n`;
                
                const nature = ed.querySelector('.p-nature').value; if(nature) txt += `${nature} Nature\n`;
                
                let ivs = []; 
                STATS.forEach(s => { 
                    const v = ed.querySelector(`.p-iv-${s.toLowerCase()}`).value; 
                    if(v != 31) ivs.push(`${v} ${s}`); 
                });
                if(ivs.length) txt += `IVs: ${ivs.join(' / ')}\n`;
                
                ed.querySelectorAll('.p-move').forEach(m => { if(m.value) txt += `- ${m.value}\n`; });
                txt += "\n";
            }
        });
        return txt;
    }

    function openIOModal() {
        const txt = getTeamAsText();
        document.getElementById('ioText').value = txt;
        document.getElementById('ioModal').style.display='flex';
    }

    async function shareTeamLink() {
        let author = document.getElementById('teamAuthorInput').value;
        if(!author.trim()) {
            author = prompt("Por favor, digite o Nick do Autor do time para gerar o link:");
            if(author) {
                document.getElementById('teamAuthorInput').value = author;
                saveCurrentTeamToStorage();
            } else {
                alert("√â necess√°rio um Nick para compartilhar.");
                return;
            }
        }

        const teamText = getTeamAsText();
        if(!teamText.trim() || teamText.length < 20) {
            alert("Monte um time antes de gerar o link!"); 
            return;
        }

        const encoded = LZString.compressToEncodedURIComponent(teamText);
        const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/')) + "/paste.html";
        const longLink = `${baseUrl}?import=${encoded}`;

        const btn = document.querySelector('.btn-share');
        const oldText = btn.innerText;
        btn.innerText = "‚è≥...";

        try {
            const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longLink)}`);
            if (response.ok) {
                const shortLink = await response.text();
                await navigator.clipboard.writeText(shortLink);
                alert("Link da Pok√©Paste copiado!\n\n" + shortLink);
            } else {
                throw new Error("Falha ao encurtar");
            }
        } catch (e) {
            await navigator.clipboard.writeText(longLink);
            alert("Link copiado! (Vers√£o completa)");
        } finally {
            btn.innerText = oldText;
        }
    }

    function publishTeam() {
        // Fun√ß√£o de placeholder caso o m√≥dulo n√£o carregue (mas a l√≥gica real est√° no m√≥dulo abaixo)
        alert("Carregando sistema de publica√ß√£o...");
    }

    function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('ioText').value); alert("Copiado!"); }
    
    function processImport() {
        const text = document.getElementById('ioText').value; if (!text.trim()) { alert("Cole um time."); return; }
        document.getElementById('tabsContainer').innerHTML = ""; document.getElementById('editorsContainer').innerHTML = "";
        slotCounter = 0; const blocks = text.split(/\r?\n\r?\n/);
        blocks.forEach(block => {
            if (!block.trim() || block.startsWith("===") || block.startsWith("//")) return;
            const id = addNewSlot();
            const lines = block.split('\n'); const firstLine = lines[0].trim();
            let name = firstLine, item = "";
            if (firstLine.includes('@')) { const p = firstLine.split('@'); name = p[0].trim(); item = p[1].trim(); }
            
            const ed = document.getElementById(`editor-${id}`);
            if (name.includes('(M)')) { ed.querySelector('.p-gender').value = 'M'; name = name.replace('(M)', ''); }
            else if (name.includes('(F)')) { ed.querySelector('.p-gender').value = 'F'; name = name.replace('(F)', ''); }
            name = name.trim();
            if (name.includes('(') && name.includes(')')) { const m = name.match(/\(([^)]+)\)/); if (m) name = m[1]; }

            const nInp = ed.querySelector('.p-name'); nInp.value = name; updatePokemon(id, nInp, true); 
            const iInp = ed.querySelector('.p-item'); iInp.value = item; updateItemIcon(id, iInp);

            let mIdx = 0; const mInps = ed.querySelectorAll('.p-move');
            for(let i=1; i<lines.length; i++) {
                const l = lines[i].trim();
                if (l.startsWith('Ability:')) ed.querySelector('.p-ability').value = l.replace('Ability:', '').trim();
                else if (l.includes('Nature')) ed.querySelector('.p-nature').value = l.split(' ')[0];
                else if (l.startsWith('Level:')) ed.querySelector('.p-level').value = l.replace('Level:', '').trim();
                else if (l.startsWith('Shiny:')) ed.querySelector('.p-shiny').value = l.includes('Yes') ? 'Yes' : 'No';
                else if (l.startsWith('EVs:')) {
                    const p = l.replace('EVs:', '').split('/');
                    p.forEach(x => { x=x.trim(); const v=parseInt(x); STATS.forEach(s=>{ if(x.includes(s)) updateEV(id,s,v); }); });
                }
                else if (l.startsWith('IVs:')) {
                    const p = l.replace('IVs:', '').split('/');
                    p.forEach(x => { x=x.trim(); const v=parseInt(x); STATS.forEach(s=>{ if(x.includes(s)) ed.querySelector(`.p-iv-${s.toLowerCase()}`).value = v; }); });
                }
                else if (l.startsWith('-')) { if(mIdx<4) { mInps[mIdx].value = l.replace('-','').trim(); mIdx++; } }
            }
            setTimeout(() => recalcStats(id), 500);
        });
        document.getElementById('ioModal').style.display='none';
        saveCurrentTeamToStorage();
    }
  </script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { 
    getAuth, 
    signInWithPopup, 
    GoogleAuthProvider, 
    signOut, 
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    updateProfile
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  
  import { 
    getDatabase, 
    ref, 
    push, 
    set,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCno7O_ZGLTDYvSG5kzYU-KpduucWcxQe8",
    authDomain: "sampleteans.firebaseapp.com",
    databaseURL: "https://sampleteans-default-rtdb.firebaseio.com",
    projectId: "sampleteans",
    storageBucket: "sampleteans.firebasestorage.app",
    messagingSenderId: "1069510029261",
    appId: "1:1069510029261:web:ccafa840ebf0e2a0e85e84"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getDatabase(app); 
  const provider = new GoogleAuthProvider();

  // --- Elementos de Auth ---
  const loginForm = document.getElementById('loginForm');
  const userProfile = document.getElementById('userProfile');
  const emailInput = document.getElementById('emailInput');
  const passInput = document.getElementById('passInput');
  const btnGoogleLogin = document.getElementById('btnGoogleLogin');
  const btnEmailLogin = document.getElementById('btnEmailLogin');
  const btnEmailRegister = document.getElementById('btnEmailRegister');
  const btnLogout = document.getElementById('btnLogout');
  const userPhoto = document.getElementById('userPhoto');
  const userName = document.getElementById('userName');
  const userEmail = document.getElementById('userEmail');

  // --- L√ìGICA DE PUBLICAR COMPLETA ---
  window.publishTeam = async function() {
      // Bloqueio de Valida√ß√£o (Silencioso para o usuario corrigir, mas impede o envio)
      if (!validateTeam(true)) { 
          return; 
      }
      
      const user = auth.currentUser;
      
      if(!user) {
          alert("Voc√™ precisa estar logado para publicar!");
          document.getElementById("menuBtn").classList.add("active"); 
          document.querySelector(".sidebar").style.display = "flex";
          return;
      }

      const title = document.getElementById('teamNameInput').value;
      const author = document.getElementById('teamAuthorInput').value;
      const tier = document.getElementById('teamTier').value;
      const teamText = getTeamAsText(); 

      if(!title || title === "Novo Time") { alert("D√™ um nome ao time."); return; }
      if(!tier) { alert("Selecione uma Tier."); return; }
      if(teamText.length < 50) { alert("O time parece estar vazio."); return; }

      let sprites = [];
      document.querySelectorAll('.poke-editor').forEach(ed => {
          const name = ed.querySelector('.p-name').value;
          if(name) sprites.push(name.toLowerCase());
      });

      const btn = document.querySelector('.btn-publish');
      const originalText = btn.innerHTML;
      btn.innerHTML = "Enviando...";
      btn.disabled = true;

      try {
          // --- REALTIME DATABASE ---
          const teamsListRef = ref(db, 'teams');
          const newTeamRef = push(teamsListRef);
          
          await set(newTeamRef, {
              title: title,
              author: author || user.displayName || "Treinador",
              tier: tier,
              teamData: teamText,
              pokemon: sprites,
              userId: user.uid,
              userPhoto: user.photoURL || null,
              createdAt: serverTimestamp()
          });

          alert("Time publicado com sucesso no Feed!");
      } catch (error) {
          console.error("Erro ao publicar: ", error);
          alert("Erro ao publicar: " + error.message);
      } finally {
          btn.innerHTML = originalText;
          btn.disabled = false;
      }
  }

  // --- M√âTODOS DE AUTH ---
  if(btnGoogleLogin) {
      btnGoogleLogin.addEventListener('click', () => {
        signInWithPopup(auth, provider).then(async (result) => {
             if(confirm(`Logado como ${result.user.displayName}. Alterar Nick?`)) {
                 const newNick = prompt("Novo Nick:");
                 if(newNick) {
                     await updateProfile(result.user, { displayName: newNick });
                     location.reload();
                 }
            }
        }).catch((e) => alert("Erro: " + e.message));
      });
  }

  if(btnEmailLogin) {
      btnEmailLogin.addEventListener('click', () => {
        signInWithEmailAndPassword(auth, emailInput.value, passInput.value)
            .catch((e) => alert("Erro Login: " + e.message));
      });
  }

  if(btnEmailRegister) {
      btnEmailRegister.addEventListener('click', () => {
        if(passInput.value.length < 6) { alert("Senha curta."); return; }
        createUserWithEmailAndPassword(auth, emailInput.value, passInput.value)
            .then(async (cred) => {
                const nick = prompt("Qual seu Nick de Treinador?");
                if(nick) await updateProfile(cred.user, { displayName: nick });
                location.reload();
            })
            .catch((e) => alert("Erro Cadastro: " + e.message));
      });
  }

  if(btnLogout) {
      btnLogout.addEventListener('click', () => {
        if(confirm("Sair?")) signOut(auth).then(() => location.reload());
      });
  }

  onAuthStateChanged(auth, (user) => {
    if (user) {
      if(loginForm) loginForm.style.display = 'none';
      if(userProfile) {
          userProfile.style.display = 'flex';
          userPhoto.src = user.photoURL ? user.photoURL : "https://i.imgur.com/XOEcuO8.png"; 
          userName.innerText = user.displayName ? user.displayName : "Treinador";
          userEmail.innerText = user.email;

          const authorInput = document.getElementById('teamAuthorInput');
          if(authorInput && !authorInput.value && user.displayName) {
              authorInput.value = user.displayName;
          }
      }
    } else {
      if(loginForm) loginForm.style.display = 'flex';
      if(userProfile) userProfile.style.display = 'none';
    }
  });
</script>
</body>
</html>

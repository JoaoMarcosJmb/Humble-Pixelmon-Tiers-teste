<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Humble Builder - Ultimate</title>
  
  <link rel="icon" type="image/png" href="img/mike_anotando2.png">
  
  <style>
    /* --- CSS GERAL --- */
    :root { 
      --cor-dourado: #d1a720; 
      --cor-fundo: #1a1a1a; 
      --cor-texto: #f5f5f5; 
      --cor-input: #252525; 
      --cor-borda: #444;
    }

    body { 
      font-family: "Segoe UI", Arial, sans-serif; 
      background: linear-gradient(135deg, rgba(15,15,15,0.95), rgba(30,25,20,0.95)), 
                  url("https://i.imgur.com/vATNRmF.png"); 
      background-size: cover; 
      background-attachment: fixed;
      margin: 0; padding-top: 80px; color: var(--cor-texto); 
    }
    
    /* --- HEADER --- */
    header { 
      position: fixed; top: 0; left: 0; right: 0; width: 100%; padding: 10px 20px; 
      display: flex; justify-content: space-between; align-items: center; 
      background: rgba(15, 15, 15, 0.98); border-bottom: 2px solid var(--cor-dourado); 
      z-index: 1000; box-sizing: border-box; box-shadow: 0 4px 15px rgba(0,0,0,0.7);
    }
    header h1 { font-size: 1.4rem; color: var(--cor-dourado); display: flex; gap: 10px; margin: 0; align-items: center; }
    header h1 img { height: 35px; }
    header a { text-decoration: none; color: inherit; display:flex; align-items:center; gap:10px; }

    .menu-toggle { display: flex; flex-direction: column; width: 30px; gap: 6px; cursor: pointer; z-index: 1100; }
    .menu-toggle span { display: block; height: 3px; background: var(--cor-texto); border-radius: 4px; transition: 0.3s; }
    .menu-toggle.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 6px); }
    .menu-toggle.active span:nth-child(2) { opacity: 0; }
    .menu-toggle.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -6px); }

    nav { 
      position: absolute; top: 60px; right: 20px; background: rgba(30, 25, 20, 0.98); 
      border: 1px solid var(--cor-dourado); border-radius: 8px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.8); display: none; 
      flex-direction: column; padding: 15px; gap: 12px; z-index: 1200; width: 220px; 
    }
    nav.active { display: flex; }
    nav a { color: var(--cor-dourado); font-weight: 500; transition: 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; }

    /* --- LAYOUT --- */
    .builder-wrapper { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* --- TELA 1: LISTA DE TIMES --- */
    #teamListSection { display: block; }
    
    .team-list-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        border-bottom: 1px solid #444; padding-bottom: 10px;
    }
    .btn-new-team {
        background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; 
        font-weight: bold; cursor: pointer; font-size: 1rem;
    }
    .btn-new-team:hover { background: #218838; }

    .saved-team-card {
        background: rgba(40,40,40,0.9); border: 1px solid #555; border-radius: 8px;
        padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;
        transition: transform 0.2s, border-color 0.2s; cursor: pointer;
    }
    .saved-team-card:hover { transform: translateX(5px); border-color: var(--cor-dourado); }

    .team-info { display: flex; flex-direction: column; gap: 5px; }
    .team-meta { font-size: 0.9rem; color: #aaa; font-weight: bold; }
    .team-name-display { font-size: 1.1rem; color: var(--cor-dourado); font-weight: bold; }
    
    .team-icons-preview { display: flex; gap: 5px; margin-top: 5px; }
    .mini-icon { width: 30px; height: 30px; object-fit: contain; }

    .team-actions { display: flex; gap: 10px; }
    .btn-icon { background: transparent; border: none; color: #888; font-size: 1.2rem; cursor: pointer; z-index: 10; }
    .btn-icon:hover { color: #fff; }
    .btn-delete:hover { color: #ff4d4d; }

    /* --- TELA 2: BUILDER --- */
    #builderSection { display: none; }

    /* TOOLBAR */
    .toolbar {
      display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
      background: rgba(30,30,30,0.8); padding: 15px; border-radius: 8px; border: 1px solid var(--cor-borda);
      flex-wrap: wrap; gap: 15px;
    }
    .toolbar-left { display: flex; align-items: center; gap: 10px; }
    .toolbar-controls { display: flex; gap: 10px; align-items: center; height: 42px; }

    .tier-select {
        background: #111; color: var(--cor-dourado); border: 1px solid var(--cor-dourado);
        padding: 0 15px; border-radius: 5px; font-weight: bold; cursor: pointer;
        font-size: 0.95rem; min-width: 180px; height: 100%; box-sizing: border-box;
    }
    .tier-select option { background: #222; color: #fff; }

    .btn-action {
        background: var(--cor-dourado); border: none; padding: 0 15px; font-weight: bold;
        cursor: pointer; border-radius: 4px; color: #111; font-size: 0.9rem; transition: 0.2s;
        height: 100%; display: flex; align-items: center; gap: 5px;
    }
    .btn-action:hover { background: #fff; }
    .btn-back { background: #444; color: #fff; }
    .btn-back:hover { background: #666; }

    /* --- ABAS --- */
    .tabs-wrapper { display: flex; align-items: flex-end; gap: 5px; margin-bottom: 0; padding-left: 5px; }
    .tab-slot {
        background: #222; border: 1px solid #444; border-bottom: none; border-radius: 8px 8px 0 0;
        width: 60px; height: 45px; cursor: pointer; display: flex; justify-content: center; align-items: center;
        opacity: 0.6; transition: all 0.2s; position: relative;
    }
    .tab-slot:hover { opacity: 0.9; background: #2a2a2a; }
    .tab-slot.active {
        opacity: 1; background: rgba(25, 25, 25, 0.95); border-color: var(--cor-dourado);
        border-bottom: 1px solid rgba(25, 25, 25, 0.95); height: 50px; z-index: 10; margin-bottom: -1px;
    }
    .tab-icon { width: 35px; height: 35px; object-fit: contain; pointer-events: none; }
    .tab-close { 
        position: absolute; top: 2px; right: 4px; font-size: 14px; color: #888; display: none; 
        line-height: 10px;
    }
    .tab-slot:hover .tab-close { display: block; cursor: pointer; color: #ff4d4d; }

    .add-tab-btn {
        width: 40px; height: 40px; background: #222; border: 1px dashed #666; border-radius: 8px 8px 0 0;
        color: #888; font-size: 1.5rem; cursor: pointer; display: flex; justify-content: center; align-items: center;
    }
    .add-tab-btn.hidden { display: none; }

    /* --- EDITOR --- */
    .editor-container-wrapper {
        background: rgba(25, 25, 25, 0.95); border: 1px solid var(--cor-dourado); border-radius: 0 8px 8px 8px; 
        padding: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.5); min-height: 500px;
    }
    .poke-editor { display: none; animation: fadeIn 0.3s ease; }
    .poke-editor.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    
    .header-row { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
    .header-row h4 { margin: 0; color: var(--cor-dourado); font-size: 1.2rem; }

    .editor-layout { display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap; margin-top: 15px; }
    
    /* Lado Esquerdo: Imagem + Stats */
    .left-panel { display: flex; flex-direction: row; gap: 15px; flex-shrink: 0; }
    .visual-large-box {
        width: 140px; height: 140px; background: rgba(0,0,0,0.3); border: 1px solid #444; border-radius: 10px;
        display: flex; justify-content: center; align-items: center; flex: none;
    }
    .poke-sprite-large { width: 110px; height: 110px; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6)); }

    .base-stats-panel { 
        background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; border: 1px solid #333; 
        font-size: 0.8rem; flex-grow: 1; min-width: 200px; 
    }
    .stat-bar-row { display: flex; align-items: center; margin-bottom: 4px; gap: 5px; }
    .stat-name { width: 25px; font-weight: bold; color: #888; }
    .stat-val-base { width: 25px; text-align: center; color: #aaa; }
    .stat-val-final { width: 30px; text-align: right; color: #fff; font-weight: bold; }
    .bar-track { flex-grow: 1; background: #333; height: 6px; border-radius: 3px; overflow: hidden; }
    .bar-fill { height: 100%; width: 0%; border-radius: 3px; transition: width 0.3s; }
    
    .bar-hp { background: #FF5959; } .bar-atk { background: #F5AC78; } .bar-def { background: #FAE078; }
    .bar-spa { background: #9DB7F5; } .bar-spd { background: #A7DB8D; } .bar-spe { background: #FA92B2; }

    .inputs-area { flex-grow: 1; min-width: 300px; display: flex; flex-direction: column; gap: 10px; }
    .row { display: flex; gap: 10px; } .col { flex: 1; } .col-small { width: 70px; flex:none; } .col-mini { width: 55px; flex:none; }
    
    /* Inputs com Clear X */
    .input-wrapper { position: relative; width: 100%; display: flex; align-items: center; }
    .clear-x { 
        position: absolute; right: 8px; top: 50%; transform: translateY(-50%); 
        color: #666; cursor: pointer; font-size: 1.2rem; display: none; z-index: 5;
    }
    .clear-x:hover { color: #ff4d4d; }
    .input-wrapper input:not(:placeholder-shown) + .clear-x { display: block; }

    .input-with-icon { display: flex; align-items: center; gap: 8px; width: 100%; }
    .item-icon-img { width: 30px; height: 30px; object-fit: contain; opacity: 0.3; transition: opacity 0.3s; }
    .item-icon-img.active { opacity: 1; }

    label { display: block; font-size: 0.75rem; color: #888; margin-bottom: 2px; }
    input[type="text"], input[type="number"], select {
        background: var(--cor-input); border: 1px solid var(--cor-borda); color: #fff;
        padding: 6px 25px 6px 10px; /* Padding extra na direita pro X */
        border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 0.9rem; height: 34px;
    }
    input:focus, select:focus { border-color: var(--cor-dourado); outline: none; background: #303030; }

    .iv-section { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; border: 1px solid #333; }
    .iv-grid { display: flex; gap: 10px; justify-content: space-between; }
    .iv-box { text-align: center; width: 100%; }
    .iv-box label { font-size: 0.75rem; color: #666; }
    .iv-box input { text-align: center; font-size: 0.9rem; background: #1a1a1a; padding: 5px; }

    .stats-box { margin-top: 10px; }
    .ev-header { display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px; color: #aaa; }
    .stat-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
    .stat-label { width: 30px; font-weight: bold; font-size: 0.85rem; color: #888; }
    input[type=range] { -webkit-appearance: none; width: 100%; height: 6px; background: #333; border-radius: 3px; outline: none; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; background: var(--cor-dourado); border-radius: 50%; cursor: pointer; }
    .ev-num { width: 50px !important; text-align: center; padding: 0 !important; font-size: 0.9rem !important; }

    .move-input { border-left: 4px solid #555 !important; margin-bottom: 8px; height: 38px !important; }
    .move-input:focus { border-left-color: var(--cor-dourado) !important; }

    /* MODAL */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; }
    .modal-content { background: #1a1a1a; border: 2px solid var(--cor-dourado); padding: 20px; border-radius: 10px; width: 90%; max-width: 600px; }
    .modal-textarea { width: 100%; height: 250px; background: #222; color: #fff; border: 1px solid #444; padding: 10px; font-family: monospace; resize: vertical; }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }

  </style>
</head>
<body>

  <datalist id="list-pokemon"></datalist>
  <datalist id="list-items"></datalist>

  <div class="modal-overlay" id="ioModal">
    <div class="modal-content">
      <h3 style="margin-top:0; color:var(--cor-dourado)">Importar / Exportar (Texto)</h3>
      <textarea id="ioText" class="modal-textarea" spellcheck="false"></textarea>
      <div class="modal-buttons">
        <button class="btn-action" style="background:#444;" onclick="document.getElementById('ioModal').style.display='none'">Fechar</button>
        <button class="btn-action" style="background:#444;" onclick="copyToClipboard()">Copiar</button>
        <button class="btn-action" onclick="processImport()">Carregar</button>
      </div>
    </div>
  </div>

  <header>
    <h1><a href="feed.html"><img src="https://i.imgur.com/XOEcuO8.png"> Humble Builder</a></h1>
    <div class="menu-toggle" id="menuBtn"><span></span><span></span><span></span></div>
  </header>

  <nav id="dropdownMenu">
    <a href="feed.html">üè† In√≠cio (Feed)</a>
    <a href="https://www.humblepixelmon.com.br">üåê Site Oficial</a>
    <a href="#">üó°Ô∏è Tiers 1.12</a>
    <a href="#">üõ°Ô∏è Tiers 1.16</a>
    <a href="#">üìù Notas de Atualiza√ß√£o</a>
  </nav>

  <div class="builder-wrapper">
    
    <div id="teamListSection">
        <div class="team-list-header">
            <h2 style="color:var(--cor-dourado); margin:0;">Meus Times</h2>
            <button class="btn-new-team" onclick="createNewTeam()">+ Novo Time</button>
        </div>
        <div id="savedTeamsContainer">
            </div>
        <p id="noTeamsMsg" style="color:#666; text-align:center; display:none;">Nenhum time salvo. Crie um novo!</p>
    </div>

    <div id="builderSection">
        <div class="toolbar">
            <div class="toolbar-left">
                <button class="btn-action btn-back" onclick="showTeamList()">‚¨Ö Voltar</button>
                <div style="display:flex; flex-direction:column;">
                    <input type="text" id="teamNameInput" placeholder="Nome do Time (ex: Chuva)" style="background:transparent; border:none; border-bottom:1px solid #555; color:#fff; font-size:1.1rem; padding:2px;">
                </div>
            </div>
            
            <div class="toolbar-controls">
                <select id="teamTier" class="tier-select" onchange="carregarDados(this.value)">
                    <option value="" disabled selected>Selecionar Tier</option>
                    <option value="AG">AG</option><option value="LC">LC</option><option value="Monotype">Monotype</option>
                    <option value="NU">NU</option><option value="National_Dex">National Dex</option>
                    <option value="National_Dex_Monotype">NatDex Monotype</option><option value="National_Dex_RU">NatDex RU</option>
                    <option value="National_Dex_UU">NatDex UU</option><option value="National_Dex_Ubers">NatDex Ubers</option>
                    <option value="OU">OU</option><option value="PU">PU</option><option value="RU">RU</option>
                    <option value="UU">UU</option><option value="Uber">Uber</option><option value="Ubers_UU">Ubers UU</option><option value="ZU">ZU</option>
                </select>
                
                <button class="btn-action" style="background:#444; border:1px solid #666;" onclick="openIOModal()">üì• Texto</button>
                <button class="btn-action" style="background:#28a745;" onclick="saveCurrentTeamToStorage()">üíæ Salvar</button>
            </div>
        </div>

        <div class="tabs-wrapper">
            <div id="tabsContainer" style="display:flex; gap:5px;"></div>
            <button id="addSlotBtn" class="add-tab-btn" onclick="addNewSlot()">+</button>
        </div>

        <div class="editor-container-wrapper" id="editorsContainer"></div>
    </div>

  </div>

  <script>
    // --- GERAIS ---
    const menuBtn = document.getElementById("menuBtn");
    const dropdownMenu = document.getElementById("dropdownMenu");
    menuBtn.addEventListener("click", () => { menuBtn.classList.toggle("active"); dropdownMenu.classList.toggle("active"); });

    const MAX_EVS = 508; const MAX_SLOTS = 6;
    const STATS = ['HP', 'Atk', 'Def', 'SpA', 'SpD', 'Spe'];
    const NATURES_INFO = { "Adamant": "+Atk, -SpA", "Bashful": "Neutral", "Bold": "+Def, -Atk", "Brave": "+Atk, -Spe", "Calm": "+SpD, -Atk", "Careful": "+SpD, -SpA", "Docile": "Neutral", "Gentle": "+SpD, -Def", "Hardy": "Neutral", "Hasty": "+Spe, -Def", "Impish": "+Def, -SpA", "Jolly": "+Spe, -SpA", "Lax": "+Def, -SpD", "Lonely": "+Atk, -Def", "Mild": "+SpA, -Def", "Modest": "+SpA, -Atk", "Naive": "+Spe, -SpD", "Naughty": "+Atk, -SpD", "Quiet": "+SpA, -Spe", "Quirky": "Neutral", "Rash": "+SpA, -SpD", "Relaxed": "+Def, -Spe", "Sassy": "+SpD, -Spe", "Serious": "Neutral", "Timid": "+Spe, -Atk" };
    const IMG_PATH = "img/official-artwork/"; const IMG_ERROR = "https://img.pokemondb.net/sprites/items/poke-ball.png"; 
    const ITEM_ICON_BASE = "https://play.pokemonshowdown.com/sprites/itemicons/";

    let pokemonIdMap = {}; let todosItens = [];
    let slotCounter = 0; let slotBaseStats = {}; 
    let allTeams = []; let currentTeamIndex = null;

    function formatToApiName(name) { return name.trim().toLowerCase().replace(/ /g, '-').replace(/\./g, '').replace(/'/g, '').replace(/:/g, '').replace(/‚ôÄ/g, '-f').replace(/‚ôÇ/g, '-m'); }
    function formatItemToShowdown(name) { return name.toLowerCase().replace(/[^a-z0-9]/g, ''); }
    function formatText(str) { if (!str) return ''; return str.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' '); }

    window.onload = async function() { 
        await initItens(); 
        loadAllTeams(); 
    };

    async function initItens() {
        try { const r = await fetch('builder/itens.json'); if (r.ok) { todosItens = await r.json(); atualizarListaItens(null); } } catch (e) {}
    }
    
    function showTeamList() {
        document.getElementById('teamListSection').style.display = 'block';
        document.getElementById('builderSection').style.display = 'none';
        loadAllTeams();
    }

    function showBuilder() {
        document.getElementById('teamListSection').style.display = 'none';
        document.getElementById('builderSection').style.display = 'block';
    }

    // --- GEST√ÉO DE TIMES ---
    function loadAllTeams() {
        const data = localStorage.getItem('humbleTeamsList');
        if (data) allTeams = JSON.parse(data); else allTeams = [];

        const container = document.getElementById('savedTeamsContainer');
        container.innerHTML = "";
        
        if (allTeams.length === 0) document.getElementById('noTeamsMsg').style.display = 'block';
        else document.getElementById('noTeamsMsg').style.display = 'none';

        allTeams.forEach((team, index) => {
            const div = document.createElement('div');
            div.className = 'saved-team-card';
            div.onclick = (e) => { if(!e.target.closest('.btn-icon')) editTeam(index); };

            let iconsHtml = '';
            team.slots.forEach(s => {
                if(s.name) {
                    const apiName = formatToApiName(s.name);
                    let src = pokemonIdMap[s.name] ? `${IMG_PATH}${pokemonIdMap[s.name]}.png` : `${IMG_PATH}${apiName}.png`; 
                    iconsHtml += `<img src="${src}" class="mini-icon" onerror="this.src='${IMG_ERROR}'">`;
                }
            });

            div.innerHTML = `
                <div class="team-info">
                    <span class="team-meta">[${team.tier || 'Sem Tier'}]</span>
                    <span class="team-name-display">${team.title || 'Untitled Team'}</span>
                    <div class="team-icons-preview">${iconsHtml}</div>
                </div>
                <div class="team-actions">
                    <button class="btn-icon" onclick="deleteTeam(${index})">üóëÔ∏è</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function createNewTeam() {
        currentTeamIndex = null;
        document.getElementById('teamNameInput').value = "";
        document.getElementById('teamTier').value = "";
        
        document.getElementById('tabsContainer').innerHTML = "";
        document.getElementById('editorsContainer').innerHTML = "";
        slotCounter = 0;
        addNewSlot(); 
        
        showBuilder();
    }

    function editTeam(index) {
        currentTeamIndex = index;
        const team = allTeams[index];
        
        document.getElementById('teamNameInput').value = team.title || "";
        document.getElementById('teamTier').value = team.tier || "";
        carregarDados(team.tier);

        document.getElementById('tabsContainer').innerHTML = "";
        document.getElementById('editorsContainer').innerHTML = "";
        slotCounter = 0;

        if (team.slots && team.slots.length > 0) {
            team.slots.forEach(s => {
                const id = addNewSlot();
                const ed = document.getElementById(`editor-${id}`);
                ed.querySelector('.p-name').value = s.name;
                updateImage(id, ed.querySelector('.p-name')); 
                
                ed.querySelector('.p-item').value = s.item;
                updateItemIcon(id, ed.querySelector('.p-item'));

                ed.querySelector('.p-ability').value = s.ability;
                ed.querySelector('.p-nature').value = s.nature;
                ed.querySelector('.p-level').value = s.level;
                ed.querySelector('.p-gender').value = s.gender || '-';
                ed.querySelector('.p-shiny').value = s.shiny || 'No';
                
                STATS.forEach(stat => {
                    updateEV(id, stat, s.evs[stat] || 0);
                    ed.querySelector(`.p-iv-${stat.toLowerCase()}`).value = s.ivs[stat] || 31;
                });

                const movesInp = ed.querySelectorAll('.p-move');
                s.moves.forEach((m, i) => { if(movesInp[i]) movesInp[i].value = m; });
                
                setTimeout(() => recalcStats(id), 200);
            });
            switchTab(1);
        } else {
            addNewSlot();
        }
        showBuilder();
    }

    function saveCurrentTeamToStorage() {
        const teamData = {
            title: document.getElementById('teamNameInput').value || "Untitled Team",
            tier: document.getElementById('teamTier').value,
            slots: []
        };

        document.querySelectorAll('.poke-editor').forEach(ed => {
            const id = ed.id.split('-')[1];
            const name = ed.querySelector('.p-name').value;
            if(!name) return; 

            const slot = {
                name: name,
                item: ed.querySelector('.p-item').value,
                ability: ed.querySelector('.p-ability').value,
                nature: ed.querySelector('.p-nature').value,
                level: ed.querySelector('.p-level').value,
                gender: ed.querySelector('.p-gender').value,
                shiny: ed.querySelector('.p-shiny').value,
                evs: {}, ivs: {}, moves: []
            };
            STATS.forEach(s => {
                slot.evs[s] = document.getElementById(`num-${id}-${s}`).value;
                slot.ivs[s] = ed.querySelector(`.p-iv-${s.toLowerCase()}`).value;
            });
            ed.querySelectorAll('.p-move').forEach(m => slot.moves.push(m.value));
            teamData.slots.push(slot);
        });

        if (currentTeamIndex === null) {
            allTeams.push(teamData); 
            currentTeamIndex = allTeams.length - 1; 
        } else {
            allTeams[currentTeamIndex] = teamData; 
        }

        localStorage.setItem('humbleTeamsList', JSON.stringify(allTeams));
        alert("Time salvo com sucesso!");
    }

    function deleteTeam(index) {
        if(confirm("Tem certeza que deseja deletar este time?")) {
            allTeams.splice(index, 1);
            localStorage.setItem('humbleTeamsList', JSON.stringify(allTeams));
            loadAllTeams();
        }
    }

    // --- BUILDER LOGIC ---
    function carregarDados(tier) { 
        if(!tier) return;
        const dl = document.getElementById('list-pokemon'); dl.innerHTML = "";
        fetch(`tiers_1.16/${tier}.json`).then(r => r.json()).then(d => {
            Object.keys(d).forEach(n => {
                const o = document.createElement('option'); o.value = n; dl.appendChild(o);
                if(d[n].id) pokemonIdMap[n] = d[n].id;
            });
        }).catch(e=>{});
        atualizarListaItens(tier);
    }
    
    function atualizarListaItens(tier) {
        const dl = document.getElementById('list-items'); dl.innerHTML = "";
        todosItens.forEach(i => {
            if(tier && i.ban && i.ban.includes(tier)) return;
            const o = document.createElement('option'); o.value = i.name; dl.appendChild(o);
        });
    }

    function addNewSlot() {
        if (document.querySelectorAll('.tab-slot').length >= MAX_SLOTS) return;
        slotCounter++; const id = slotCounter;
        const tab = document.createElement('div'); tab.className='tab-slot'; tab.id=`tab-${id}`; tab.onclick=()=>switchTab(id);
        tab.innerHTML = `<span class="tab-close" onclick="removeSlot(${id}, event)">√ó</span><img src="${IMG_ERROR}" id="tab-img-${id}" class="tab-icon">`;
        document.getElementById('tabsContainer').appendChild(tab);
        const ed = document.createElement('div'); ed.className='poke-editor'; ed.id=`editor-${id}`; ed.innerHTML=generateEditorHTML(id);
        document.getElementById('editorsContainer').appendChild(ed);
        slotBaseStats[id] = {hp:0,atk:0,def:0,spa:0,spd:0,spe:0};
        switchTab(id);
        updateAddBtnVisibility();
        return id;
    }
    function removeSlot(id,e){ 
        if(e)e.stopPropagation(); 
        const tab = document.getElementById(`tab-${id}`);
        const wasActive = tab.classList.contains('active');
        document.getElementById(`tab-${id}`).remove(); document.getElementById(`editor-${id}`).remove(); 
        delete slotBaseStats[id];
        if (wasActive) {
            const tabs = document.querySelectorAll('.tab-slot');
            if(tabs.length > 0) switchTab(tabs[tabs.length-1].id.split('-')[1]);
            else addNewSlot();
        }
        updateAddBtnVisibility(); 
    }
    function switchTab(id){ document.querySelectorAll('.tab-slot').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.poke-editor').forEach(e=>e.classList.remove('active')); document.getElementById(`tab-${id}`)?.classList.add('active'); document.getElementById(`editor-${id}`)?.classList.add('active'); }
    function updateAddBtnVisibility(){ document.getElementById('addSlotBtn').classList.toggle('hidden', document.querySelectorAll('.tab-slot').length >= MAX_SLOTS); }

    function generateEditorHTML(id) {
        const nOpts = Object.keys(NATURES_INFO).map(n=>`<option value="${n}">${n}</option>`).join('');
        return `<div class="editor-layout"><div class="left-panel"><div class="visual-large-box"><img src="${IMG_ERROR}" id="img-${id}" class="poke-sprite-large"></div><div class="base-stats-panel" id="stats-panel-${id}">${STATS.map(s=>`<div class="stat-bar-row"><span class="stat-name">${s}</span><span class="stat-val-base" id="base-${id}-${s.toLowerCase()}">0</span><div class="bar-track"><div class="bar-fill bar-${s.toLowerCase()}" id="bar-${id}-${s.toLowerCase()}"></div></div><span class="stat-val-final" id="val-${id}-${s.toLowerCase()}">0</span></div>`).join('')}<div style="text-align:right;">Total: <span id="bst-${id}">0</span></div></div></div><div class="inputs-area"><div class="row"><div class="col"><label>Pok√©mon</label><input type="text" class="p-name" list="list-pokemon" onchange="updatePokemon('${id}',this)"></div><div class="col"><label>Item</label><div class="input-wrapper"><input type="text" class="p-item" list="list-items" oninput="updateItemIcon('${id}',this)"><span class="clear-x" onclick="clearItem('${id}')">√ó</span></div><img id="item-icon-${id}" class="item-icon-img" style="position:absolute; right:35px; top:32px;"></div></div><div class="row"><datalist id="abilities-${id}"></datalist><div class="col"><label>Ability</label><input type="text" class="p-ability" list="abilities-${id}"></div><div class="col"><label>Nature</label><select class="p-nature" onchange="recalcStats('${id}')"><option value="" disabled>Nature</option>${nOpts}</select></div><div class="col-small"><label>Level</label><input type="number" class="p-level" value="100" onchange="recalcStats('${id}')"></div><div class="col-mini"><label>Gender</label><select class="p-gender"><option value="-">-</option><option value="M">M</option><option value="F">F</option></select></div><div class="col-mini"><label>Shiny</label><select class="p-shiny"><option value="No">No</option><option value="Yes">Yes</option></select></div></div><div class="iv-section"><div class="iv-grid">${STATS.map(s=>`<div class="iv-box"><label>${s}</label><input type="text" class="p-iv-${s.toLowerCase()}" value="31" onchange="recalcStats('${id}')"></div>`).join('')}</div></div></div></div><div class="stats-box"><div class="ev-header"><span>EVs</span><span id="remain-${id}" class="ev-remaining">508</span></div>${STATS.map(s=>`<div class="stat-row"><span class="stat-label">${s}</span><input type="range" min="0" max="252" oninput="updateEV('${id}','${s}',this.value)" id="range-${id}-${s}"><input type="number" class="ev-num" min="0" max="252" onchange="updateEV('${id}','${s}',this.value)" id="num-${id}-${s}"></div>`).join('')}</div><datalist id="moves-${id}"></datalist><div style="margin-top:20px;"><div class="input-wrapper" style="margin-bottom:8px;"><input type="text" class="move-input p-move" list="moves-${id}" placeholder="- Move 1"><span class="clear-x" onclick="clearInput(this)">√ó</span></div><div class="input-wrapper" style="margin-bottom:8px;"><input type="text" class="move-input p-move" list="moves-${id}" placeholder="- Move 2"><span class="clear-x" onclick="clearInput(this)">√ó</span></div><div class="input-wrapper" style="margin-bottom:8px;"><input type="text" class="move-input p-move" list="moves-${id}" placeholder="- Move 3"><span class="clear-x" onclick="clearInput(this)">√ó</span></div><div class="input-wrapper"><input type="text" class="move-input p-move" list="moves-${id}" placeholder="- Move 4"><span class="clear-x" onclick="clearInput(this)">√ó</span></div></div>`;
    }

    function clearItem(id) {
        const editor = document.getElementById(`editor-${id}`);
        const input = editor.querySelector('.p-item');
        input.value = "";
        updateItemIcon(id, input);
    }
    function clearInput(btn) { btn.previousElementSibling.value = ""; }

    async function updatePokemon(id, el) {
        const val = el.value; if(val.length<2) return;
        const apiName = formatToApiName(val);
        const img = document.getElementById(`img-${id}`); const tabImg = document.getElementById(`tab-img-${id}`);
        
        if (pokemonIdMap[val]) {
            img.src = `${IMG_PATH}${pokemonIdMap[val]}.png`;
            tabImg.src = `${IMG_PATH}${pokemonIdMap[val]}.png`;
        } else {
            img.src = `${IMG_PATH}${apiName}.png`;
            tabImg.src = `${IMG_PATH}${apiName}.png`;
        }
        
        try {
            const r = await fetch(`https://pokeapi.co/api/v2/pokemon/${apiName}`);
            if(r.ok) {
                const d = await r.json();
                slotBaseStats[id] = { hp:d.stats[0].base_stat, atk:d.stats[1].base_stat, def:d.stats[2].base_stat, spa:d.stats[3].base_stat, spd:d.stats[4].base_stat, spe:d.stats[5].base_stat };
                recalcStats(id);
                
                const abilList = document.getElementById(`abilities-${id}`); abilList.innerHTML="";
                d.abilities.forEach(a=>{ const o=document.createElement('option'); o.value=formatText(a.ability.name); abilList.appendChild(o); });
                
                const moveList = document.getElementById(`moves-${id}`); moveList.innerHTML="";
                d.moves.forEach(m=>{ const o=document.createElement('option'); o.value=formatText(m.move.name); moveList.appendChild(o); });
            }
        } catch(e){}
    }

    function updateItemIcon(id, input) {
        const val = input.value;
        const icon = document.getElementById(`item-icon-${id}`);
        if (!val || val.length < 2) { icon.src=""; icon.classList.remove('active'); return; }
        icon.src = `${ITEM_ICON_BASE}${formatItemToShowdown(val)}.png`;
        icon.classList.add('active');
        icon.onerror = function() { this.src=""; this.classList.remove('active'); }
    }

    function updateEV(id,stat,val) {
        val = parseInt(val)||0;
        document.getElementById(`range-${id}-${stat}`).value = val;
        document.getElementById(`num-${id}-${stat}`).value = val;
        let total=0; STATS.forEach(s=>{ if(s!==stat) total+=parseInt(document.getElementById(`num-${id}-${s}`).value)||0; });
        const remain = 508 - (total+val);
        document.getElementById(`remain-${id}`).innerText = "Restam: "+remain;
        recalcStats(id);
    }

    function recalcStats(id) {
        const base = slotBaseStats[id] || {hp:0,atk:0,def:0,spa:0,spd:0,spe:0};
        const level = parseInt(document.getElementById(`editor-${id}`).querySelector('.p-level').value) || 100;
        const nature = document.getElementById(`editor-${id}`).querySelector('.p-nature').value;
        let mods = { atk:1, def:1, spa:1, spd:1, spe:1 };
        if(NATURES_INFO[nature] && NATURES_INFO[nature]!=="Neutral") {
            const parts = NATURES_INFO[nature].split(', ');
            parts.forEach(p => { 
                const type = p.substring(1).toLowerCase(); 
                if(p.startsWith('+')) mods[type]=1.1; 
                if(p.startsWith('-')) mods[type]=0.9; 
            });
        }
        let total=0;
        STATS.forEach(s => {
            const k = s.toLowerCase();
            const b = base[k];
            document.getElementById(`base-${id}-${k}`).innerText = b;
            const iv = parseInt(document.getElementById(`editor-${id}`).querySelector(`.p-iv-${k}`).value)||0;
            const ev = parseInt(document.getElementById(`num-${id}-${s}`).value)||0;
            let final = 0;
            if(b>0) {
                if(s==='HP') final = b===1?1 : Math.floor(((2*b+iv+Math.floor(ev/4))*level)/100)+level+10;
                else final = Math.floor((Math.floor(((2*b+iv+Math.floor(ev/4))*level)/100)+5)*mods[k]);
            }
            document.getElementById(`val-${id}-${k}`).innerText = final;
            document.getElementById(`bar-${id}-${k}`).style.width = Math.min((b/255)*100, 100)+"%";
            total += final;
        });
        document.getElementById(`bst-${id}`).innerText = total;
    }

    // Modal Import/Export (Copia/Cola Texto)
    function openIOModal() {
        let txt = ""; 
        const tier = document.getElementById('teamTier').value;
        if(tier) txt += `=== [Gen 9] ${tier} ===\n\n`;
        document.querySelectorAll('.poke-editor').forEach(ed=>{
            const name = ed.querySelector('.p-name').value;
            if(name) {
                let line1 = name;
                const gender = ed.querySelector('.p-gender').value;
                const item = ed.querySelector('.p-item').value;
                if(gender !== '-') line1 += ` (${gender})`;
                if(item) line1 += ` @ ${item}`;
                txt += `${line1}\n`;
                
                const ability = ed.querySelector('.p-ability').value;
                if(ability) txt += `Ability: ${ability}\n`;
                
                const shiny = ed.querySelector('.p-shiny').value;
                if(shiny === 'Yes') txt += `Shiny: Yes\n`;
                
                let evs = []; STATS.forEach(s => { const v = document.getElementById(`num-${ed.id.split('-')[1]}-${s}`).value; if(v>0) evs.push(`${v} ${s}`); });
                if(evs.length) txt += `EVs: ${evs.join(' / ')}\n`;
                
                const nature = ed.querySelector('.p-nature').value;
                if(nature) txt += `${nature} Nature\n`;
                
                let ivs = []; STATS.forEach(s => { const v = ed.querySelector(`.p-iv-${s.toLowerCase()}`).value; if(v!=31) ivs.push(`${v} ${s}`); });
                if(ivs.length) txt += `IVs: ${ivs.join(' / ')}\n`;

                ed.querySelectorAll('.p-move').forEach(m => { if(m.value) txt += `- ${m.value}\n`; });
                txt += "\n";
            }
        });
        document.getElementById('ioText').value = txt;
        document.getElementById('ioModal').style.display='flex';
    }
    function copyToClipboard() { navigator.clipboard.writeText(document.getElementById('ioText').value); alert("Copiado!"); }
    
    function processImport() {
        const text = document.getElementById('ioText').value;
        if (!text.trim()) { alert("Cole um time para importar."); return; }

        document.getElementById('tabsContainer').innerHTML = '';
        document.getElementById('editorsContainer').innerHTML = '';
        slotCounter = 0;

        const blocks = text.split(/\r?\n\r?\n/);
        blocks.forEach(block => {
            if (!block.trim() || block.startsWith("===")) return;
            const id = addNewSlot();
            if (!id) return;

            const lines = block.split('\n');
            const firstLine = lines[0].trim();
            let name = firstLine, item = "";
            if (firstLine.includes('@')) { const p = firstLine.split('@'); name = p[0].trim(); item = p[1].trim(); }
            
            const ed = document.getElementById(`editor-${id}`);
            
            if (name.includes('(M)')) { ed.querySelector('.p-gender').value = 'M'; name = name.replace('(M)', ''); }
            else if (name.includes('(F)')) { ed.querySelector('.p-gender').value = 'F'; name = name.replace('(F)', ''); }
            name = name.trim();

            if (name.includes('(') && name.includes(')')) {
                const m = name.match(/\(([^)]+)\)/);
                if (m) name = m[1];
            }

            const nInp = ed.querySelector('.p-name'); nInp.value = name; 
            updateImage(id, nInp); 
            
            const iInp = ed.querySelector('.p-item'); iInp.value = item; updateItemIcon(id, iInp);

            let mIdx = 0; const mInps = ed.querySelectorAll('.p-move');
            for (let i = 1; i < lines.length; i++) {
                const l = lines[i].trim();
                if (l.startsWith('Ability:')) ed.querySelector('.p-ability').value = l.replace('Ability:', '').trim();
                else if (l.includes('Nature')) ed.querySelector('.p-nature').value = l.split(' ')[0];
                else if (l.startsWith('Level:')) ed.querySelector('.p-level').value = l.replace('Level:', '').trim();
                else if (l.startsWith('Shiny:')) ed.querySelector('.p-shiny').value = l.includes('Yes') ? 'Yes' : 'No';
                else if (l.startsWith('EVs:')) {
                    const p = l.replace('EVs:', '').split('/');
                    p.forEach(x => { x = x.trim(); const v = parseInt(x); STATS.forEach(s => { if (x.includes(s)) updateEV(id, s, v); }); });
                }
                else if (l.startsWith('IVs:')) {
                    const p = l.replace('IVs:', '').split('/');
                    p.forEach(x => { x = x.trim(); const v = parseInt(x); STATS.forEach(s => { if (x.includes(s)) ed.querySelector(`.p-iv-${s.toLowerCase()}`).value = v; }); });
                }
                else if (l.startsWith('-')) { if (mIdx < 4) { mInps[mIdx].value = l.replace('-', '').trim(); mIdx++; } }
            }
            setTimeout(() => recalcStats(id), 500);
        });
        document.getElementById('ioModal').style.display='none';
        saveCurrentTeamToStorage();
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Humble Paste - Visualizador</title>
  <link rel="icon" type="image/png" href="img/mike_anotando2.png">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>

  <style>
    :root { 
      --cor-dourado: #d1a720; 
      --cor-fundo: #111; 
      --cor-painel: rgba(30, 30, 30, 0.95);
      --cor-texto: #f5f5f5; 
      --cor-borda: #444;
    }
    
    * { box-sizing: border-box; }

    body {
        font-family: "Segoe UI", Arial, sans-serif;
        background-color: var(--cor-fundo);
        background-image: linear-gradient(135deg, rgba(20,20,20,0.95), rgba(40,30,20,0.95)), 
                          url("https://i.imgur.com/vATNRmF.png");
        background-size: cover;
        background-attachment: fixed;
        color: var(--cor-texto);
        margin: 0; padding: 0;
        min-height: 100vh;
        display: flex; flex-direction: column;
    }

    header {
        height: 60px; padding: 0 20px; flex-shrink: 0;
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(20, 20, 20, 0.98); 
        border-bottom: 2px solid var(--cor-dourado);
        box-shadow: 0 4px 15px rgba(0,0,0,0.5);
    }
    h1 { 
        font-size: 1.4rem; color: var(--cor-dourado); margin: 0; 
        display: flex; gap: 10px; align-items: center; 
    }
    h1 img { height: 35px; }

    .btn-action {
        background: var(--cor-dourado); color: #111; border: none;
        padding: 8px 20px; font-weight: bold; border-radius: 4px; cursor: pointer;
        text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
        font-size: 0.9rem; transition: 0.2s;
    }
    .btn-action:hover { filter: brightness(1.1); transform: translateY(-1px); }

    .btn-outline {
        background: transparent; border: 1px solid #666; color: #888;
        padding: 6px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
        transition: 0.2s; margin: 0 auto 30px; display: block;
    }
    .btn-outline:hover { border-color: var(--cor-dourado); color: var(--cor-dourado); background: rgba(209, 167, 32, 0.1); }

    /* --- INFO DO TIME (AUTOR / TIER) --- */
    .team-header-info {
        width: 100%; max-width: 1200px; margin: 20px auto 0;
        text-align: center; background: rgba(0,0,0,0.4);
        border: 1px solid #333; border-radius: 8px; padding: 15px;
        backdrop-filter: blur(5px); display: none; /* Inicia oculto */
    }
    .team-tier-badge {
        display: inline-block; background: #333; color: var(--cor-dourado);
        padding: 5px 12px; border-radius: 20px; font-size: 0.85rem;
        border: 1px solid #555; text-transform: uppercase; letter-spacing: 1px;
        margin-bottom: 8px;
    }
    .team-author {
        font-size: 1.2rem; color: #fff; margin: 0;
    }
    .team-author span { color: var(--cor-dourado); font-weight: bold; }

    .container {
        max-width: 1200px; margin: 20px auto; width: 100%;
        display: flex; flex-wrap: wrap; gap: 20px; justify-content: center;
        padding: 20px; flex-grow: 1; align-items: flex-start;
    }

    .poke-card {
        background: var(--cor-painel);
        border: 1px solid var(--cor-borda);
        border-top: 3px solid var(--cor-dourado);
        border-radius: 8px;
        width: 350px;
        height: 420px;
        padding: 15px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        display: flex; flex-direction: column;
        transition: transform 0.2s;
        position: relative;
    }
    .poke-card:hover { transform: translateY(-3px); border-color: #666; }

    .card-header { 
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 8px;
        height: 45px;
    }
    .poke-name { font-size: 1.3rem; font-weight: bold; color: #fff; margin: 0; text-transform: capitalize; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    .poke-item-text { 
        font-size: 0.9rem; color: #bbb; font-style: italic; 
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        max-width: 140px; text-align: right;
    }

    .visual-area {
        display: flex; align-items: center; gap: 15px; margin-bottom: 15px;
        background: rgba(0,0,0,0.3); border-radius: 6px; padding: 10px; border: 1px solid #333;
        flex-grow: 1;
    }
    .main-sprite { 
        width: 100px; height: 100px; object-fit: contain; 
        filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); 
        flex-shrink: 0;
    }
    
    .info-list { font-size: 0.85rem; color: #ccc; line-height: 1.5; width: 100%; }
    .info-list div { margin-bottom: 3px; border-bottom: 1px solid #252525; padding-bottom: 2px; }
    .info-list div:last-child { border-bottom: none; }
    .info-list strong { color: var(--cor-dourado); font-weight: normal; margin-right: 4px; }

    .moves-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin-top: auto;
        height: 90px; align-content: start;
    }
    .move-tag {
        background: #252525; padding: 4px; text-align: center; border-radius: 4px;
        font-size: 0.8rem; color: #ddd; border: 1px solid #444;
        display: flex; align-items: center; justify-content: center;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .raw-text-area {
        width: 90%; max-width: 800px; margin: 0 auto 30px; background: #151515; 
        padding: 20px; border: 1px solid var(--cor-dourado); color: #aaa; font-family: monospace; 
        white-space: pre-wrap; border-radius: 6px; display: none; font-size: 0.9rem;
    }
  </style>
</head>
<body>

<header>
    <h1><img src="https://i.imgur.com/XOEcuO8.png"> Humble Paste</h1>
    <a href="#" id="editBtn" class="btn-action">✎ Importar / Editar</a>
</header>

<div id="teamInfoArea" class="team-header-info">
    <div id="displayTier" class="team-tier-badge">FORMATO</div>
    <h2 class="team-author">Treinador: <span id="displayAuthor">???</span></h2>
</div>

<div class="container" id="cardsContainer">
    <h2 style="color:#888; font-weight:normal;">Lendo dados do time...</h2>
</div>

<button onclick="toggleRaw()" class="btn-outline">(Ver Texto Original)</button>
<div id="rawText" class="raw-text-area"></div>

<script>
    // --- LÓGICA DE NOMES DO SHOWDOWN (Ultimate) ---
    function toShowdownName(rawName) {
        if (!rawName) return "pokeball";
        let name = rawName.toLowerCase();

        // Limpeza inicial
        if (name.includes("@")) name = name.split("@")[0];
        name = name.replace(/\(.*\)/g, "").trim();

        // REGRAS ESPECÍFICAS
        if (name.includes("mega") && !name.includes("yanmega") && !name.includes("meganium")) {
            if (name.includes(" x") || name.includes("-x")) return name.replace("mega", "").replace(" x", "").replace("-x", "").replace(/[^a-z0-9]/g, "") + "-megax";
            if (name.includes(" y") || name.includes("-y")) return name.replace("mega", "").replace(" y", "").replace("-y", "").replace(/[^a-z0-9]/g, "") + "-megay";
            return name.replace("mega", "").replace(/[^a-z0-9]/g, "") + "-mega";
        }
        if (name.includes("origin")) return name.replace("origin", "").replace("forme", "").replace(/[^a-z0-9]/g, "") + "-origin";
        if (name.includes("zacian")) return name.includes("crowned") ? "zacian-crowned" : "zacian";
        if (name.includes("zamazenta")) return name.includes("crowned") ? "zamazenta-crowned" : "zamazenta";
        if (name.includes("deoxys")) {
            if (name.includes("attack")) return "deoxys-attack";
            if (name.includes("defense")) return "deoxys-defense";
            if (name.includes("speed")) return "deoxys-speed";
            return "deoxys";
        }
        if (name.includes("tauros")) {
            if (name.includes("aqua")) return "tauros-paldeaaqua";
            if (name.includes("blaze")) return "tauros-paldeablaze";
            if (name.includes("combat") || name.includes("paldea")) return "tauros-paldeacombat";
            return "tauros";
        }
        if (name.includes("kyurem")) {
            if (name.includes("black")) return "kyurem-black";
            if (name.includes("white")) return "kyurem-white";
            return "kyurem";
        }
        if (name.includes("ogerpon")) {
            if (name.includes("cornerstone")) return "ogerpon-cornerstone";
            if (name.includes("hearthflame")) return "ogerpon-hearthflame";
            if (name.includes("wellspring")) return "ogerpon-wellspring";
            return "ogerpon";
        }
        if (name.includes("lycanroc")) {
            if (name.includes("midnight")) return "lycanroc-midnight";
            if (name.includes("dusk")) return "lycanroc-dusk";
            return "lycanroc";
        }
        if (name.includes("necrozma")) {
            if (name.includes("dawn")) return "necrozma-dawnwings";
            if (name.includes("dusk") || name.includes("mane")) return "necrozma-duskmane";
            if (name.includes("ultra")) return "necrozma-ultra";
            return "necrozma";
        }
        if (name.includes("palafin")) return name.includes("hero") ? "palafin-hero" : "palafin";
        if (name.includes("primal")) return name.replace("primal", "").replace(/[^a-z0-9]/g, "") + "-primal";
        if (name.includes("indeedee")) return (name.includes("-f") || name.includes("female")) ? "indeedee-f" : "indeedee";
        
        if (name.includes("galar")) return name.replace("galarian", "").replace("galar", "").replace(/[^a-z0-9]/g, "") + "-galar";
        if (name.includes("alola")) return name.replace("alolan", "").replace("alola", "").replace(/[^a-z0-9]/g, "") + "-alola";
        if (name.includes("hisui")) return name.replace("hisuian", "").replace("hisui", "").replace(/[^a-z0-9]/g, "") + "-hisui";

        // EXCEÇÕES (Paradoxos e outros com hífen obrigatório)
        const exceptions = {
            "ho-oh": "ho-oh", "porygon-z": "porygon-z", "wo-chien": "wo-chien", "chien-pao": "chien-pao", 
            "ting-lu": "ting-lu", "chi-yu": "chi-yu", "type: null": "typenull", "jangmo-o": "jangmo-o", 
            "hakamo-o": "hakamo-o", "kommo-o": "kommo-o", "urshifu-rapid-strike": "urshifu-rapid-strike", 
            "urshifu-single-strike": "urshifu", "calyrex-shadow": "calyrex-shadow", "calyrex-ice": "calyrex-ice", 
            "meowstic-f": "meowstic-f", "meowstic": "meowstic", "basculegion-f": "basculegion-f", 
            "basculegion": "basculegion", "oinkologne-f": "oinkologne-f", "oinkologne": "oinkologne",
            "great-tusk": "great-tusk", "scream-tail": "scream-tail", "brute-bonnet": "brute-bonnet",
            "flutter-mane": "flutter-mane", "slither-wing": "slither-wing", "sandy-shocks": "sandy-shocks",
            "iron-treads": "iron-treads", "iron-bundle": "iron-bundle", "iron-hands": "iron-hands",
            "iron-jugulis": "iron-jugulis", "iron-moth": "iron-moth", "iron-thorns": "iron-thorns",
            "iron-valiant": "iron-valiant", "roaring-moon": "roaring-moon", "walking-wake": "walking-wake",
            "iron-leaves": "iron-leaves"
        };
        const checkName = name.replace(/ /g, "-").replace(/[^a-z0-9-]/g, "");
        if (exceptions[checkName]) return exceptions[checkName];

        return name.replace(/[^a-z0-9]/g, "");
    }

    // --- DIRETÓRIOS DE IMAGENS DO SHOWDOWN ---
    const BASE_ANI = "https://play.pokemonshowdown.com/sprites/ani/";
    const BASE_ANI_SHINY = "https://play.pokemonshowdown.com/sprites/ani-shiny/";
    const BASE_STATIC = "https://play.pokemonshowdown.com/sprites/gen5/";
    const BASE_STATIC_SHINY = "https://play.pokemonshowdown.com/sprites/gen5-shiny/";
    const IMG_FALLBACK = "https://img.pokemondb.net/sprites/items/poke-ball.png";

    window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const code = params.get('import');

        if(!code) {
            document.getElementById('cardsContainer').innerHTML = "<h3 style='color:#ff5555'>Erro: Link incompleto.</h3>";
            document.getElementById('editBtn').style.display = 'none';
            document.getElementById('teamInfoArea').style.display = 'none';
            return;
        }

        let fullText = "";
        try {
            fullText = LZString.decompressFromEncodedURIComponent(code);
            if(!fullText) fullText = decodeURIComponent(escape(atob(code))); 
        } catch(e) {
            fullText = "Erro ao ler código.";
        }

        extractMetadata(fullText);

        const builderFile = "builder (15).html"; 
        document.getElementById('editBtn').href = `${builderFile}?import=${code}`;
        document.getElementById('rawText').innerText = fullText;

        const pokemons = parseShowdown(fullText);
        renderCards(pokemons);
    };

    function extractMetadata(text) {
        const tierMatch = text.match(/^===\s+(.*?)\s+===/m);
        const authorMatch = text.match(/^\/\/\s+Author:\s+(.*)$/m);
        const infoArea = document.getElementById('teamInfoArea');
        
        if (tierMatch) document.getElementById('displayTier').innerText = tierMatch[1].trim();
        else document.getElementById('displayTier').style.display = 'none';

        if (authorMatch) document.getElementById('displayAuthor').innerText = authorMatch[1].trim();
        else document.getElementById('displayAuthor').innerText = "Desconhecido";

        if(text.trim().length > 10) infoArea.style.display = 'block';
    }

    function parseShowdown(text) {
        if(!text) return [];
        const blocks = text.split(/\r?\n\r?\n/);
        const team = [];

        blocks.forEach(block => {
            if(!block.trim() || block.trim().startsWith("===") || block.trim().startsWith("//")) return;
            
            const lines = block.split('\n');
            const pokemon = { moves: [], shiny: false }; // Padrão shiny false
            
            const firstLine = lines[0].split('@');
            let namePart = firstLine[0].trim();
            namePart = namePart.replace(/\s?[\(\[][MF][\)\]]$/i, '').trim();
            
            if(namePart.includes('(') && namePart.includes(')')) {
                const match = namePart.match(/\(([^)]+)\)/);
                if(match) pokemon.name = match[1]; 
                else pokemon.name = namePart;
            } else {
                pokemon.name = namePart; 
            }
            pokemon.display = namePart;

            if(firstLine[1]) pokemon.item = firstLine[1].trim();

            for(let i=1; i<lines.length; i++) {
                const l = lines[i].trim();
                if (l.startsWith('//')) continue;
                
                if(l.startsWith('Ability:')) pokemon.ability = l.split(':')[1].trim();
                else if(l.startsWith('EVs:')) pokemon.evs = l.split(':')[1].trim();
                else if(l.startsWith('IVs:')) pokemon.ivs = l.split(':')[1].trim();
                else if(l.includes('Nature')) pokemon.nature = l.split(' ')[0];
                else if(l.startsWith('Shiny:')) pokemon.shiny = true; // Detecta Shiny
                else if(l.startsWith('-')) pokemon.moves.push(l.substring(1).trim());
            }
            team.push(pokemon);
        });
        return team;
    }

    function renderCards(team) {
        const container = document.getElementById('cardsContainer');
        container.innerHTML = "";

        if(team.length === 0) {
             container.innerHTML = "<h3 style='color:#888'>Nenhum Pokémon encontrado.</h3>";
             return;
        }

        for (const [index, pk] of team.entries()) {
            const cleanName = toShowdownName(pk.name);
            
            // Define URLs com base no Shiny
            const folderAni = pk.shiny ? BASE_ANI_SHINY : BASE_ANI;
            const folderStatic = pk.shiny ? BASE_STATIC_SHINY : BASE_STATIC;

            const srcAni = `${folderAni}${cleanName}.gif`;
            const srcStatic = `${folderStatic}${cleanName}.png`;

            const card = document.createElement('div');
            card.className = 'poke-card';
            
            // O evento 'onerror' garante: Tenta GIF -> Falhou? Tenta PNG -> Falhou? Poke Bola
            card.innerHTML = `
                <div class="card-header">
                    <span class="poke-name">${pk.display}</span>
                    <span class="poke-item-text">${pk.item || ''}</span>
                </div>
                <div class="visual-area">
                    <img src="${srcAni}" 
                         class="main-sprite"
                         title="${pk.shiny ? 'Shiny' : 'Normal'}"
                         onerror="this.onerror=null; this.src='${srcStatic}'; this.onerror=function(){this.src='${IMG_FALLBACK}'};">
                    <div class="info-list">
                        <div><strong>Ability:</strong> ${pk.ability || '-'}</div>
                        <div><strong>Nature:</strong> ${pk.nature || '-'}</div>
                        <div><strong>EVs:</strong> ${pk.evs || '-'}</div>
                        <div><strong>IVs:</strong> ${pk.ivs || '-'}</div>
                    </div>
                </div>
                <div class="moves-grid">
                    ${pk.moves.map(m => `<div class="move-tag">${m}</div>`).join('')}
                </div>
            `;
            container.appendChild(card);
        }
    }

    function toggleRaw() {
        const div = document.getElementById('rawText');
        div.style.display = (div.style.display === 'block') ? 'none' : 'block';
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Humble - Times (Debugged)</title>
  <style>
    :root{
      --cor-dourado:#d1a720;
      --cor-fundo:#1a1a1a;
      --cor-texto:#f5f5f5;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:"Segoe UI",Arial,sans-serif;
      background: linear-gradient(135deg, rgba(20,20,20,0.85), rgba(40,30,20,0.85)),
                url("https://i.imgur.com/vATNRmF.png") no-repeat center center fixed;
      background-size:cover;color:var(--cor-texto);min-height:100vh;
    }

    /* Header */
    header{position:fixed;top:0;left:0;right:0;padding:15px 20px;
      display:flex;align-items:center;justify-content:space-between;background:rgba(20,20,20,0.9);
      border-bottom:2px solid var(--cor-dourado);z-index:1000}
    header h1{display:flex;align-items:center;gap:12px;margin:0;color:var(--cor-dourado);font-size:1.4rem}
    header h1 img{height:36px}
    .header-right{display:flex;align-items:center;gap:10px}

    .btn{background:none;border:1px solid var(--cor-dourado);color:var(--cor-dourado);
      padding:6px 10px;border-radius:6px;cursor:pointer}
    .btn:hover{background:var(--cor-dourado);color:var(--cor-fundo)}

    /* hamburger (exactly as requested) */
    .menu-toggle{display:flex;flex-direction:column;justify-content:space-between;width:30px;height:22px;cursor:pointer}
    .menu-toggle span{display:block;height:4px;background:var(--cor-texto);border-radius:4px;transition:0.25s}
    .menu-toggle.active span:nth-child(1){transform:rotate(45deg) translate(5px,5px)}
    .menu-toggle.active span:nth-child(2){opacity:0}
    .menu-toggle.active span:nth-child(3){transform:rotate(-45deg) translate(5px,-5px)}

    nav#dropdownMenu{position:absolute;top:65px;right:10px;background:rgba(30,25,20,0.95);
      border:1px solid var(--cor-dourado);border-radius:12px;padding:12px;display:none;flex-direction:column;gap:8px;z-index:1100}
    nav#dropdownMenu.active{display:flex}
    nav#dropdownMenu a{color:var(--cor-dourado);text-decoration:none}
    nav#dropdownMenu a:hover{color:var(--cor-texto)}

    /* main */
    main{padding:100px 20px 40px;max-width:1100px;margin:0 auto}
    #criarTimeBtn{display:block;margin:0 auto 16px auto;margin-top:64px;background:var(--cor-dourado);color:var(--cor-fundo);
      border:none;padding:10px 16px;border-radius:8px;cursor:pointer;font-weight:700}
    #criarTimeBtn:hover{background:#f1c53b}

    .time-card{background:rgba(30,25,20,0.9);border:1px solid var(--cor-dourado);border-radius:12px;padding:14px;margin-bottom:14px}

    /* modal */
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);justify-content:center;align-items:center;z-index:2000;padding:20px}
    .modal.open{display:flex}
    .modal-panel{width:100%;max-width:880px;background:rgba(30,25,20,0.98);border:2px solid var(--cor-dourado);
      border-radius:12px;padding:18px;color:var(--cor-texto);max-height:90vh;overflow:auto}

    /* auth */
    .row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .col{flex:1}
    input[type="text"], input[type="email"], input[type="password"], select{
      width:100%;padding:8px;border-radius:6px;background:#111;border:1px solid #333;color:var(--cor-texto)
    }

    /* pokemon builder */
    #pokemonList{display:flex;flex-direction:column;gap:10px;margin-bottom:12px}
    .poke-card-wrapper{display:block}
    .poke-card{background:rgba(20,20,20,0.9);border:1px solid var(--cor-dourado);padding:12px;border-radius:10px}
    .poke-card h4{margin:0 0 8px 0;color:var(--cor-dourado)}
    .stat{display:flex;gap:8px;align-items:center;margin-bottom:6px}
    .stat label{width:50px}
    .stat input[type="range"]{flex:1}
    .stat .val{width:36px;text-align:right;color:var(--cor-dourado);font-weight:700}

    .progress{height:8px;background:#333;border-radius:6px;overflow:hidden;margin-top:8px}
    .progress-bar{height:100%;background:var(--cor-dourado);width:0%;transition:0.2s}

    .small{font-size:0.9rem;color:#ccc}
    .danger{color:#ff8b8b}

    @media (max-width:700px){
      .row{flex-direction:column}
      header h1{font-size:1.1rem}
      #criarTimeBtn{margin-top:90px}
    }
  </style>
</head>
<body>

  <header>
    <h1>
      <a href="index.html"><img src="https://i.imgur.com/XOEcuO8.png" alt="Mascote"></a>Humble
    </h1>

    <div class="header-right">
      <button id="loginBtn" class="btn">Login</button>
      <button id="signupBtn" class="btn">Cadastrar</button>

      <div class="menu-toggle" id="menuBtn">
        <span></span><span></span><span></span>
      </div>
    </div>

    <nav id="dropdownMenu">
      <a href="index.html">üè† In√≠cio</a>
      <a href="https://www.humblepixelmon.com.br" target="_blank">üåê Site Oficial</a>
      <a href="Tiers_1.12.html">üó°Ô∏è Tiers 1.12</a>
      <a href="Tiers_1.16.html">üõ°Ô∏è Tiers 1.16</a>
      <a href="notas.html">üìù Notas de Atualiza√ß√£o</a>
    </nav>
  </header>

  <button id="criarTimeBtn">+ Criar Time</button>

  <main id="timesContainer">
    <!-- saved teams appear here -->
  </main>

  <!-- AUTH Modal -->
  <div id="authModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <h2>Entrar / Cadastrar</h2>
      <div style="display:flex;gap:8px;margin-bottom:12px">
        <button class="btn" id="tabEntrar">Entrar</button>
        <button class="btn" id="tabCadastrar">Cadastrar</button>
      </div>

      <div id="entrarView">
        <div class="row">
          <input id="loginEmail" type="email" placeholder="Email" class="col" />
          <input id="loginSenha" type="password" placeholder="Senha" class="col" />
          <button class="btn" id="loginEmailBtn">Entrar</button>
        </div>
        <div style="margin:8px 0">
          <div class="small">ou</div>
          <button class="btn" id="loginGoogleBtn">Entrar com Google</button>
        </div>
      </div>

      <div id="cadastrarView" style="display:none">
        <div class="row">
          <input id="signupEmail" type="email" placeholder="Email" class="col" />
          <input id="signupSenha" type="password" placeholder="Senha" class="col" />
        </div>
        <div style="margin-bottom:8px">
          <label class="small">Nick no jogo (√∫nico)</label>
          <input id="signupNick" type="text" maxlength="20" placeholder="SeuNickAqui" />
          <div class="small" style="color:#ffb86b;margin-top:6px">‚ö†Ô∏è O nick n√£o poder√° ser alterado depois. Apenas um usu√°rio por nick.</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn" id="signupEmailBtn">Criar conta</button>
          <button class="btn" id="signupGoogleBtn">Criar com Google</button>
        </div>
      </div>

      <div id="chooseNickView" style="display:none;margin-top:12px">
        <h3>Escolha um Nick</h3>
        <input id="chooseNickInput" type="text" maxlength="20" placeholder="Escolha um nick √∫nico" />
        <div class="small" style="color:#ffb86b;margin-top:6px">‚ö†Ô∏è N√£o ser√° poss√≠vel alterar depois.</div>
        <div style="margin-top:8px">
          <button class="btn" id="chooseNickBtn">Confirmar Nick</button>
          <div id="chooseNickMsg" class="small danger" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- TIME Modal -->
  <div id="timeModal" class="modal" aria-hidden="true">
    <div class="modal-panel">
      <h2>Criador de Time</h2>
      <div class="small" style="margin-bottom:10px">Adicione pok√©mons um por vez (at√© 6). IVs/EVs validados.</div>

      <div id="pokemonList"></div>

      <div style="display:flex;gap:8px;align-items:center;margin-top:12px">
        <button id="addPokemonBtn" class="btn">‚ûï Adicionar Pok√©mon</button>
        <div class="small" style="margin-left:8px">(<span id="pokemonCount">0</span>/6)</div>
      </div>

      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="btn" id="cancelTimeBtn">Cancelar</button>
        <button id="submitTimeBtn" class="btn" style="background:var(--cor-dourado);color:var(--cor-fundo)">Salvar Time</button>
      </div>
    </div>
  </div>

  <!-- ========== UI SCRIPT (non-module): menu, modals, builder, sliders ========== -->
  <script>
    (function(){
      // Basic UI (works even if Firebase fails)
      const menuBtn = document.getElementById("menuBtn");
      const dropdownMenu = document.getElementById("dropdownMenu");
      const loginBtn = document.getElementById("loginBtn");
      const signupBtn = document.getElementById("signupBtn");
      const authModal = document.getElementById("authModal");
      const entrarView = document.getElementById("entrarView");
      const cadastrarView = document.getElementById("cadastrarView");
      const chooseNickView = document.getElementById("chooseNickView");
      const tabEntrar = document.getElementById("tabEntrar");
      const tabCadastrar = document.getElementById("tabCadastrar");
      const criarTimeBtn = document.getElementById("criarTimeBtn");
      const timeModal = document.getElementById("timeModal");
      const pokemonList = document.getElementById("pokemonList");
      const addPokemonBtn = document.getElementById("addPokemonBtn");
      const pokemonCountSpan = document.getElementById("pokemonCount");
      const cancelTimeBtn = document.getElementById("cancelTimeBtn");
      const submitTimeBtn = document.getElementById("submitTimeBtn");
      // auth inputs (UI only)
      window.UI = window.UI || {};
      UI.pendingGoogle = null;

      // STATS
      const STATS = ["HP","Atk","Def","SpA","SpD","Spe"];

      // Hamburger
      menuBtn.addEventListener("click", ()=>{
        menuBtn.classList.toggle("active");
        dropdownMenu.classList.toggle("active");
      });
      document.addEventListener("click", (e)=>{
        if (!dropdownMenu.contains(e.target) && !menuBtn.contains(e.target)) {
          menuBtn.classList.remove("active");
          dropdownMenu.classList.remove("active");
        }
      });

      // auth tabs
      tabEntrar.addEventListener("click", ()=>{ entrarView.style.display="block"; cadastrarView.style.display="none"; chooseNickView.style.display="none"; });
      tabCadastrar.addEventListener("click", ()=>{ entrarView.style.display="none"; cadastrarView.style.display="block"; chooseNickView.style.display="none"; });

      function openAuth(tab="entrar"){
        authModal.classList.add("open");
        if(tab==="entrar") tabEntrar.click(); else tabCadastrar.click();
      }
      function closeAuth(){
        authModal.classList.remove("open");
        chooseNickView.style.display = "none";
      }
      // Expose for firebase script
      window.openAuth = openAuth;
      window.closeAuth = closeAuth;

      // Login/signup buttons just open modal (actual auth done by module)
      loginBtn.addEventListener("click", ()=>{
        // module will handle signout if logged; UI just opens modal
        openAuth("entrar");
      });
      signupBtn.addEventListener("click", ()=> openAuth("cadastrar"));

      // POKEMON builder UI
      function updatePokemonCount(){
        const c = pokemonList.children.length;
        pokemonCountSpan.textContent = String(c);
        addPokemonBtn.disabled = c >= 6;
      }

      function createPokemonCard(){
        const wrapper = document.createElement("div");
        wrapper.className = "poke-card-wrapper";
        const card = document.createElement("div");
        card.className = "poke-card";

        // build inner HTML
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h4>Pok√©mon</h4>
            <div><button class="btn remove-poke">Remover</button></div>
          </div>

          <div class="row"><div style="width:110px">Tier:</div>
            <select class="tier"><option>OU</option><option>UU</option><option>NU</option><option>Uber</option></select>
          </div>

          <div class="row"><div style="width:110px">Nome:</div><input class="pokemonName" type="text" placeholder="Charizard"></div>

          <div class="row"><div style="width:110px">Nature:</div>
            <select class="nature"><option>Adamant</option><option>Modest</option><option>Jolly</option><option>Timid</option><option>Bold</option></select>
          </div>

          <div class="row"><div style="width:110px">Ability:</div><input class="ability" type="text" placeholder="Ability"></div>

          <div style="margin-top:8px"><div style="width:110px; display:inline-block">Moves:</div>
            <div style="display:inline-block; width:calc(100% - 120px)">
              <input class="move" type="text" placeholder="Move 1"><br>
              <input class="move" type="text" placeholder="Move 2"><br>
              <input class="move" type="text" placeholder="Move 3"><br>
              <input class="move" type="text" placeholder="Move 4"><br>
            </div>
          </div>

          <div style="margin-top:8px"><strong>IVs</strong></div>
          ${STATS.map(s=>`<div class="stat"><label>${s}</label><input type="range" min="0" max="31" value="31" class="iv"><div class="val iv-val">31</div></div>`).join("")}

          <div style="margin-top:8px"><strong>EVs</strong></div>
          ${STATS.map(s=>`<div class="stat"><label>${s}</label><input type="range" min="0" max="252" step="4" value="0" class="ev"><div class="val ev-val">0</div></div>`).join("")}

          <div class="progress"><div class="progress-bar"></div></div>
          <div class="ev-warning small"></div>
        `;

        wrapper.appendChild(card);

        // Remove button
        card.querySelector(".remove-poke").addEventListener("click", ()=>{
          wrapper.remove();
          updatePokemonCount();
        });

        // IV handlers
        const ivEls = card.querySelectorAll(".iv");
        ivEls.forEach((el, idx) => {
          el.addEventListener("input", (e)=>{
            const val = e.target.value;
            card.querySelectorAll(".iv-val")[idx].textContent = val;
          });
        });

        // EV handlers with constraints
        const evEls = Array.from(card.querySelectorAll(".ev"));
        evEls.forEach((el, idx) => {
          el.addEventListener("input", (e)=>{
            // sanitize: multiple of 4
            let want = Math.round((parseInt(e.target.value || 0))/4)*4;
            if (want < 0) want = 0;
            if (want > 252) want = 252;

            // sum others
            const others = evEls.reduce((acc, el2, i2) => i2 === idx ? acc : acc + parseInt(el2.value || 0), 0);
            const remaining = 508 - others;
            if (want > remaining) want = Math.floor(remaining/4)*4;
            if (want < 0) want = 0;

            // enforce at most 2 stats with 252
            const count252 = evEls.filter((el2, i2) => i2 !== idx && parseInt(el2.value || 0) === 252).length;
            if (want === 252 && count252 >= 2) {
              // reduce by 4 (or to remaining)
              want = Math.min(248, Math.floor(remaining/4)*4);
              if (want < 0) want = 0;
            }

            e.target.value = want;
            card.querySelectorAll(".ev-val")[idx].textContent = String(want);
            validateAndUpdate(card);
          });
        });

        function validateAndUpdate(cardEl){
          const evVals = Array.from(cardEl.querySelectorAll(".ev")).map(x => parseInt(x.value || 0));
          const total = evVals.reduce((a,b)=>a+b,0);
          const cnt252 = evVals.filter(v=>v===252).length;
          const warn = cardEl.querySelector(".ev-warning");
          const bar = cardEl.querySelector(".progress-bar");
          bar.style.width = `${Math.min(100, (total/508)*100)}%`;
          if (total > 508) warn.textContent = `‚ö† M√°x total 508 EVs (atual ${total})`;
          else if (cnt252 > 2) warn.textContent = `‚ö† M√°x 2 stats com 252 EVs`;
          else warn.textContent = "";
        }

        // initialize visuals
        validateAndUpdate(card);

        return wrapper;
      }

      addPokemonBtn.addEventListener("click", ()=>{
        if (pokemonList.children.length >= 6) { alert("M√°ximo 6 pok√©mons por time."); return; }
        const node = createPokemonCard();
        pokemonList.appendChild(node);
        updatePokemonCount();
      });

      updatePokemonCount();

      // open/close time modal
      criarTimeBtn.addEventListener("click", ()=>{
        // module will check auth before allowing submit; for now just open
        timeModal.classList.add("open");
      });
      cancelTimeBtn.addEventListener("click", ()=> timeModal.classList.remove("open"));
      window.addEventListener("click", (e)=> {
        if (e.target.classList && e.target.classList.contains("modal")) e.target.classList.remove("open");
      });
      document.addEventListener("keydown", (e)=> { if (e.key === "Escape") document.querySelectorAll(".modal.open").forEach(m => m.classList.remove("open")); });

      // Expose a collector for the module script to retrieve team data
      window.collectTeam = function(){
        const ST = STATS;
        const wrappers = Array.from(pokemonList.children);
        const pokes = [];
        for (const w of wrappers){
          const c = w.querySelector(".poke-card");
          const name = (c.querySelector(".pokemonName")?.value || "").trim();
          if (!name) continue;
          const tier = c.querySelector(".tier").value;
          const nature = c.querySelector(".nature").value;
          const ability = (c.querySelector(".ability")?.value || "").trim();
          const moves = Array.from(c.querySelectorAll(".move")).map(m => m.value.trim()).filter(Boolean);
          const ivs = Object.fromEntries(Array.from(c.querySelectorAll(".iv")).map((el,i)=>[ST[i], el.value]));
          const evs = Object.fromEntries(Array.from(c.querySelectorAll(".ev")).map((el,i)=>[ST[i], el.value]));
          pokes.push({ tier, name, nature, ability, moves, ivs, evs });
        }
        return pokes;
      };

      // allow module to open/close auth modal
      window.UI = window.UI || {};
      window.UI.openAuth = openAuth;
      window.UI.closeAuth = closeAuth;
      window.UI.setPendingGoogle = function(obj){ UI.pendingGoogle = obj; };

    })();
  </script>

  <!-- ========== Firebase + logic (module) ========== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getDatabase, ref, set, push, onValue, get, child, runTransaction
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ---- REPLACE WITH YOUR FIREBASE CONFIG ----
    const firebaseConfig = {
      apiKey: "FIREBASE_API_KEY",
      authDomain: "FIREBASE_AUTH_DOMAIN",
      databaseURL: "FIREBASE_DATABASE_URL",
      projectId: "FIREBASE_PROJECT_ID",
      storageBucket: "FIREBASE_STORAGE_BUCKET",
      messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
      appId: "FIREBASE_APP_ID"
    };
    // -------------------------------------------

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const provider = new GoogleAuthProvider();

    // UI refs (module)
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const authModal = document.getElementById("authModal");
    const entrarView = document.getElementById("entrarView");
    const cadastrarView = document.getElementById("cadastrarView");
    const chooseNickView = document.getElementById("chooseNickView");

    const loginEmail = document.getElementById("loginEmail");
    const loginSenha = document.getElementById("loginSenha");
    const loginEmailBtn = document.getElementById("loginEmailBtn");
    const loginGoogleBtn = document.getElementById("loginGoogleBtn");

    const signupEmail = document.getElementById("signupEmail");
    const signupSenha = document.getElementById("signupSenha");
    const signupNick = document.getElementById("signupNick");
    const signupEmailBtn = document.getElementById("signupEmailBtn");
    const signupGoogleBtn = document.getElementById("signupGoogleBtn");

    const chooseNickInput = document.getElementById("chooseNickInput");
    const chooseNickBtn = document.getElementById("chooseNickBtn");
    const chooseNickMsg = document.getElementById("chooseNickMsg");

    const timeModal = document.getElementById("timeModal");
    const submitTimeBtn = document.getElementById("submitTimeBtn");
    const pokemonList = document.getElementById("pokemonList");
    const timesContainer = document.getElementById("timesContainer");

    // helper: atomic claim of nick
    async function claimNickAtomic(nick, uid){
      const nickRef = ref(db, `nicks/${nick}`);
      try {
        const res = await runTransaction(nickRef, current => {
          if (current === null) return uid;
          return; // abort
        });
        return res.committed === true;
      } catch (err){ console.error("runTransaction", err); return false; }
    }

    // Signup with email
    signupEmailBtn.addEventListener("click", async ()=>{
      const email = (signupEmail.value||"").trim();
      const senha = signupSenha.value;
      const nick = (signupNick.value||"").trim();
      if (!email || !senha || !nick) return alert("Preencha email, senha e nick.");
      if (!/^[A-Za-z0-9_]{3,20}$/.test(nick)) return alert("Nick inv√°lido (3-20, alfanum/_).");
      try {
        const cred = await createUserWithEmailAndPassword(auth, email, senha);
        const uid = cred.user.uid;
        const ok = await claimNickAtomic(nick, uid);
        if (!ok) { await signOut(auth); return alert("Nick j√° em uso. Escolha outro."); }
        await set(ref(db, `users/${uid}`), { uid, email, provider:"email", nick });
        alert("Conta criada com sucesso!");
        window.closeAuth();
      } catch (err) {
        console.error(err);
        alert(err.message || "Erro ao criar conta.");
      }
    });

    // Login with email
    loginEmailBtn.addEventListener("click", async ()=>{
      const email = (loginEmail.value||"").trim();
      const senha = loginSenha.value;
      if (!email || !senha) return alert("Preencha email e senha.");
      try {
        await signInWithEmailAndPassword(auth, email, senha);
        window.closeAuth();
      } catch (err) { console.error(err); alert(err.message || "Erro ao entrar."); }
    });

    // Google flow (login or signup)
    let pendingGoogle = null;
    async function handleGoogleSignIn(){
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        const uid = user.uid;
        const userSnap = await get(child(ref(db), `users/${uid}`));
        if (userSnap.exists()){ window.closeAuth(); return; }
        // need nick
        pendingGoogle = { uid, email: user.email, displayName: user.displayName, photoURL: user.photoURL };
        // show choose nick UI (UI script manages views)
        entrarView.style.display = "none";
        cadastrarView.style.display = "none";
        chooseNickView.style.display = "block";
        chooseNickInput.value = "";
        chooseNickMsg.textContent = "";
      } catch (err) { console.error(err); alert(err.message || "Erro no Google sign-in."); }
    }
    signupGoogleBtn.addEventListener("click", ()=> handleGoogleSignIn());
    loginGoogleBtn.addEventListener("click", ()=> handleGoogleSignIn());

    chooseNickBtn.addEventListener("click", async ()=>{
      const nick = (chooseNickInput.value||"").trim();
      if (!nick) return chooseNickMsg.textContent = "Digite um nick.";
      if (!/^[A-Za-z0-9_]{3,20}$/.test(nick)) return chooseNickMsg.textContent = "Nick inv√°lido.";
      if (!pendingGoogle) return chooseNickMsg.textContent = "Erro, tente novamente.";
      const ok = await claimNickAtomic(nick, pendingGoogle.uid);
      if (!ok) return chooseNickMsg.textContent = "Nick j√° em uso.";
      await set(ref(db, `users/${pendingGoogle.uid}`), {
        uid: pendingGoogle.uid,
        email: pendingGoogle.email,
        provider: "google",
        nick,
        displayName: pendingGoogle.displayName || null,
        photoURL: pendingGoogle.photoURL || null
      });
      pendingGoogle = null;
      alert("Nick registrado com sucesso!");
      window.closeAuth();
    });

    // login button: signout if logged, otherwise open modal
    loginBtn.addEventListener("click", async ()=>{
      const user = auth.currentUser;
      if (user) { await signOut(auth); alert("Desconectado"); }
      else { window.openAuth("entrar"); }
    });
    signupBtn.addEventListener("click", ()=> window.openAuth("cadastrar"));

    // reflect auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        try {
          const uSnap = await get(child(ref(db), `users/${user.uid}`));
          const display = (uSnap.exists() && uSnap.val().nick) ? uSnap.val().nick : (user.displayName || user.email || "Usu√°rio");
          loginBtn.textContent = `Sair (${display})`;
        } catch {
          loginBtn.textContent = `Sair (${user.email||"Usu√°rio"})`;
        }
        window.closeAuth();
      } else {
        loginBtn.textContent = "Login";
      }
    });

    // Save team -> uses UI.collectTeam()
    submitTimeBtn.addEventListener("click", async ()=>{
      if (!auth.currentUser) { alert("Voc√™ precisa estar logado para salvar um time."); return; }
      // collect team from UI
      const pokes = window.collectTeam();
      if (!pokes || pokes.length === 0) return alert("Adicione pelo menos 1 Pok√©mon antes de salvar.");
      // validate EVs on each pokemon
      for (const p of pokes){
        const evVals = Object.values(p.evs).map(v => parseInt(v || 0));
        const total = evVals.reduce((a,b)=>a+b,0);
        const over252 = evVals.filter(v=>v===252).length;
        if (total > 508) return alert(`Pok√©mon ${p.name} tem mais de 508 EVs (corrija antes).`);
        if (over252 > 2) return alert(`Pok√©mon ${p.name} tem mais de 2 stats com 252 EVs.`);
      }
      try {
        await push(ref(db, "teams"), { ownerUid: auth.currentUser.uid, ownerEmail: auth.currentUser.email || null, pokemons: pokes, createdAt: Date.now() });
        alert("Time salvo com sucesso!");
        timeModal.classList.remove("open");
        // clear UI list
        pokemonList.innerHTML = "";
        document.getElementById("pokemonCount").textContent = "0";
      } catch (err) {
        console.error(err);
        alert("Erro ao salvar time. Veja console.");
      }
    });

    // list teams
    onValue(ref(db, "teams"), snap => {
      const timesContainer = document.getElementById("timesContainer");
      timesContainer.innerHTML = "";
      snap.forEach(childSnap => {
        const time = childSnap.val();
        const el = document.createElement("div");
        el.className = "time-card";
        // show owner nick if available
        get(child(ref(db), `users/${time.ownerUid}`)).then(usnap=>{
          const owner = (usnap.exists() && usnap.val().nick) ? usnap.val().nick : (time.ownerEmail || "Usu√°rio");
          el.innerHTML = `<h3>Time de ${owner}</h3><pre style="white-space:pre-wrap;word-break:break-word">${JSON.stringify(time.pokemons, null, 2)}</pre>`;
        }).catch(()=>{
          el.innerHTML = `<h3>Time</h3><pre style="white-space:pre-wrap;word-break:break-word">${JSON.stringify(time.pokemons, null, 2)}</pre>`;
        });
        timesContainer.appendChild(el);
      });
    });

    // Debug: show console message when module loads
    console.log("Firebase module loaded. If Firebase config is placeholder, auth/save will fail but UI will still work.");
  </script>
</body>
</html>

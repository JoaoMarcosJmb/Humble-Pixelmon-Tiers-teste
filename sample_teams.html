<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Humble - Times</title>
  <style>
    :root{
      --cor-dourado:#d1a720;
      --cor-fundo:#1a1a1a;
      --cor-texto:#f5f5f5;
      --header-h:68px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:"Segoe UI",Arial,sans-serif;
      color:var(--cor-texto);
      background: linear-gradient(135deg, rgba(20,20,20,0.85), rgba(40,30,20,0.85)),
                  url("https://i.imgur.com/vATNRmF.png") no-repeat center center fixed;
      background-size:cover; min-height:100vh;
    }

    /* ===== Header ===== */
    header{
      position:fixed; left:0; right:0; top:0;
      height:var(--header-h);
      display:flex; align-items:center; justify-content:space-between;
      padding:12px 18px;
      background:rgba(20,20,20,0.95);
      border-bottom:2px solid var(--cor-dourado);
      z-index:1000;
    }
    header h1{ display:flex; align-items:center; gap:12px; margin:0; color:var(--cor-dourado); font-size:1.4rem;}
    header h1 img{height:36px}
    .header-right{ display:flex; align-items:center; gap:10px; }

    button { cursor:pointer; border-radius:6px; border:0; }
    .btn-outline{ background:none; border:1px solid var(--cor-dourado); color:var(--cor-dourado); padding:6px 10px; }
    .btn-outline:hover{ background:var(--cor-dourado); color:var(--cor-fundo); }

    /* hamburger (as you asked) */
    .menu-toggle{ width:30px; height:22px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; }
    .menu-toggle span{ height:4px; background:var(--cor-texto); border-radius:4px; transition:0.25s; display:block;}
    .menu-toggle.active span:nth-child(1){ transform:rotate(45deg) translate(5px,5px); }
    .menu-toggle.active span:nth-child(2){ opacity:0; }
    .menu-toggle.active span:nth-child(3){ transform:rotate(-45deg) translate(5px,-5px); }

    nav#dropdownMenu{
      position:absolute; top: calc(var(--header-h) - 3px); right:10px;
      background:rgba(30,25,20,0.98); border:1px solid var(--cor-dourado); border-radius:10px;
      padding:10px; display:none; flex-direction:column; gap:8px; z-index:1100;
      min-width:200px;
    }
    nav#dropdownMenu.active{ display:flex; }
    nav#dropdownMenu a{ color:var(--cor-dourado); text-decoration:none; padding:6px; display:block; border-radius:6px; }
    nav#dropdownMenu a:hover{ background:rgba(255,215,0,0.06); color:var(--cor-texto); }

    /* ===== Main & Create button ===== */
    main{ padding: calc(var(--header-h) + 20px) 18px 40px; max-width:1100px; margin:0 auto; }
    #criarTimeBtn{
      display:block; margin: 8px auto 18px auto;
      background:var(--cor-dourado); color:var(--cor-fundo); padding:10px 16px; font-weight:700; border-radius:8px;
      box-shadow:0 2px 6px rgba(0,0,0,0.4);
    }
    #criarTimeBtn:hover{ background:#f1c53b; }

    .time-card{ background:rgba(30,25,20,0.9); border:1px solid var(--cor-dourado); padding:14px; border-radius:12px; margin-bottom:12px; }

    /* ===== Modal base ===== */
    .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); justify-content:center; align-items:center; z-index:2000; padding:18px; }
    .modal.open{ display:flex; }
    .modal-inner{ width:100%; max-width:820px; background:rgba(28,24,20,0.98); border:2px solid var(--cor-dourado); border-radius:12px; padding:18px; color:var(--cor-texto); max-height:90vh; overflow:auto; }

    /* ===== Auth modal ===== */
    .tabs{ display:flex; gap:8px; margin-bottom:12px; }
    .tabs button{ flex:1; padding:10px; background:#232121; color:var(--cor-texto); border-radius:8px; border:1px solid transparent; }
    .tabs button.active{ background:var(--cor-dourado); color:var(--cor-fundo); border-color:var(--cor-dourado); }
    form.auth-form{ display:none; gap:10px; }
    form.auth-form.active{ display:flex; flex-direction:column; }
    form.auth-form input{ padding:10px; border-radius:8px; background:#111; border:1px solid #333; color:var(--cor-texto); }
    .error{ color:#ff8b8b; font-size:0.95rem; min-height:1.1em; }

    .auth-actions{ display:flex; gap:8px; margin-top:6px; }

    /* ===== Team builder ===== */
    .pokemon-card{ border:1px solid var(--cor-dourado); border-radius:10px; padding:12px; margin-bottom:12px; background:rgba(20,20,20,0.9); }
    .pokemon-card h3{ margin:0 0 8px 0; color:var(--cor-dourado); }
    .row{ display:flex; gap:8px; align-items:center; margin:8px 0; }
    .row .label{ width:110px; color:#ccc; }
    input[type="text"], select{ padding:8px; border-radius:6px; background:#111; color:var(--cor-texto); border:1px solid #333; }
    .stat{ display:flex; gap:8px; align-items:center; margin:6px 0; }
    .stat label{ width:52px; color:#ccc; }
    .stat input[type="range"]{ flex:1; }
    .val{ width:44px; text-align:right; color:var(--cor-dourado); font-weight:700; }
    .progress{ height:8px; background:#333; border-radius:6px; overflow:hidden; margin-top:8px; }
    .progress-bar{ height:100%; background:var(--cor-dourado); width:0%; transition:0.2s; }
    .small{ font-size:0.9rem; color:#bbb; }

    @media (max-width:700px){
      header h1{ font-size:1.05rem; gap:8px; }
      .row{ flex-direction:column; align-items:stretch; }
      .row .label{ width:auto; }
    }
  </style>
</head>
<body>
  <header>
    <h1><a href="index.html" style="display:flex;align-items:center;"><img src="https://i.imgur.com/XOEcuO8.png" alt="mascote" style="height:36px;margin-right:8px;"></a>Humble</h1>

    <div class="header-right">
      <button id="loginBtn" class="btn-outline">Login</button>
      <button id="signupBtn" class="btn-outline">Cadastrar</button>

      <div class="menu-toggle" id="menuBtn">
        <span></span><span></span><span></span>
      </div>
    </div>

    <nav id="dropdownMenu">
      <a href="index.html">üè† In√≠cio</a>
      <a href="https://www.humblepixelmon.com.br" target="_blank">üåê Site Oficial</a>
      <a href="Tiers_1.12.html">üó°Ô∏è Tiers 1.12</a>
      <a href="Tiers_1.16.html">üõ°Ô∏è Tiers 1.16</a>
      <a href="notas.html">üìù Notas de Atualiza√ß√£o</a>
    </nav>
  </header>

  <main>
    <button id="criarTimeBtn">+ Criar Time</button>

    <section id="timesContainer">
      <!-- times will be listed here -->
    </section>
  </main>

  <!-- AUTH MODAL -->
  <div class="modal" id="authModal" aria-hidden="true">
    <div class="modal-inner" role="dialog" aria-modal="true">
      <div class="tabs">
        <button id="tabLogin" class="active">Entrar</button>
        <button id="tabSignup">Cadastrar</button>
      </div>

      <form id="loginForm" class="auth-form active">
        <input id="loginEmail" type="email" placeholder="Email" autocomplete="username">
        <input id="loginPassword" type="password" placeholder="Senha" autocomplete="current-password">
        <div id="loginError" class="error"></div>
        <div class="auth-actions">
          <button type="submit" class="btn-outline">Entrar</button>
          <button type="button" id="btnGoogleLogin" class="btn-outline">Entrar com Google</button>
        </div>
      </form>

      <form id="signupForm" class="auth-form">
        <input id="signupNick" type="text" placeholder="Nick do jogo (√∫nico)">
        <small class="small">‚ö†Ô∏è O nick n√£o poder√° ser alterado depois do cadastro.</small>
        <input id="signupEmail" type="email" placeholder="Email" autocomplete="email">
        <input id="signupPassword" type="password" placeholder="Senha" autocomplete="new-password">
        <div id="signupError" class="error"></div>
        <div class="auth-actions">
          <button type="submit" class="btn-outline">Cadastrar (Email)</button>
          <button type="button" id="btnGoogleSignup" class="btn-outline">Criar com Google</button>
        </div>
      </form>
    </div>
  </div>

  <!-- TEAM MODAL -->
  <div class="modal" id="timeModal" aria-hidden="true">
    <div class="modal-inner">
      <h2>Criador de Time</h2>
      <p class="small">Adicione pok√©mons um por vez (at√© 6). IVs/EVs validados.</p>

      <div id="pokemonList"></div>

      <div style="display:flex; gap:8px; align-items:center; margin-top:12px;">
        <button id="addPokemonBtn" class="btn-outline">‚ûï Adicionar Pok√©mon</button>
        <div class="small">(<span id="pokemonCount">0</span>/6)</div>
      </div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button id="cancelTimeBtn" class="btn-outline">Cancelar</button>
        <button id="saveTimeBtn" style="background:var(--cor-dourado); color:var(--cor-fundo); border-radius:8px; padding:8px 12px;">Salvar Time</button>
      </div>
    </div>
  </div>

  <!-- ===== UI SCRIPT (works even without Firebase configured) ===== -->
  <script>
    (function(){
      // quick helpers
      const $ = (s, root = document) => root.querySelector(s);
      const $$ = (s, root = document) => Array.from(root.querySelectorAll(s));

      // auth modal elements
      const authModal = $('#authModal');
      const tabLogin = $('#tabLogin');
      const tabSignup = $('#tabSignup');
      const loginForm = $('#loginForm');
      const signupForm = $('#signupForm');
      const loginError = $('#loginError');
      const signupError = $('#signupError');
      const loginBtn = $('#loginBtn');
      const signupBtn = $('#signupBtn');
      const btnGoogleLogin = $('#btnGoogleLogin');
      const btnGoogleSignup = $('#btnGoogleSignup');

      // menu
      const menuBtn = $('#menuBtn');
      const dropdownMenu = $('#dropdownMenu');
      menuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        menuBtn.classList.toggle('active');
        dropdownMenu.classList.toggle('active');
      });
      document.addEventListener('click', (e) => {
        if (!dropdownMenu.contains(e.target) && !menuBtn.contains(e.target)) {
          menuBtn.classList.remove('active');
          dropdownMenu.classList.remove('active');
        }
      });

      // auth state object (updated by Firebase module if present)
      window.authState = { loggedIn: false, displayName: null };

      // open/close auth modal
      function openAuth(tab = 'login'){
        tab === 'login' ? showLoginTab() : showSignupTab();
        authModal.classList.add('open');
        authModal.style.display = 'flex';
      }
      function closeAuth(){
        authModal.classList.remove('open');
        authModal.style.display = 'none';
        loginError.textContent = '';
        signupError.textContent = '';
      }
      window.openAuth = openAuth;
      window.closeAuth = closeAuth;

      // Tab handlers
      function showLoginTab(){
        tabLogin.classList.add('active');
        tabSignup.classList.remove('active');
        loginForm.classList.add('active');
        signupForm.classList.remove('active');
      }
      function showSignupTab(){
        tabSignup.classList.add('active');
        tabLogin.classList.remove('active');
        signupForm.classList.add('active');
        loginForm.classList.remove('active');
      }
      tabLogin.addEventListener('click', showLoginTab);
      tabSignup.addEventListener('click', showSignupTab);

      // loginBtn click: if logged -> attempt signOut (via firebase function exposed), else open modal
      loginBtn.addEventListener('click', async () => {
        if (window.authState && window.authState.loggedIn) {
          // attempt sign out via firebase if available
          if (typeof window.firebaseSignOut === 'function') {
            try {
              await window.firebaseSignOut();
              // firebase module will update authState and button text
            } catch (err) {
              alert('Erro ao deslogar: ' + (err && err.message ? err.message : String(err)));
            }
          } else {
            // no firebase configured: simulate signout UI
            window.authState.loggedIn = false;
            window.authState.displayName = null;
            updateLoginButton();
            alert('Desconectado (Firebase n√£o configurado).');
          }
        } else {
          openAuth('login');
        }
      });

      // signupBtn opens signup tab
      signupBtn.addEventListener('click', () => openAuth('signup'));

      // click outside modals closes them
      window.addEventListener('click', (e) => {
        if (e.target === authModal) closeAuth();
        if (e.target === $('#timeModal')) $('#timeModal').classList.remove('open');
      });
      // escape closes
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeAuth(); document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open')); } });

      // expose a method to update login button text (used by firebase module)
      function updateLoginButton(){
        if (window.authState.loggedIn) loginBtn.textContent = `Sair (${window.authState.displayName || 'Usu√°rio'})`;
        else loginBtn.textContent = 'Login';
      }
      window.updateLoginButton = updateLoginButton;

      // Prevent default form submit actions here ‚Äî Firebase module will attach actual behavior.
      loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        loginError.textContent = 'A a√ß√£o de login depende do Firebase. Se voc√™ j√° configurou, aguarde o m√≥dulo autenticar. Se n√£o, n√£o h√° autentica√ß√£o configurada.';
      });
      signupForm.addEventListener('submit', (e) => {
        e.preventDefault();
        signupError.textContent = 'A a√ß√£o de cadastro depende do Firebase. Se voc√™ j√° configurou, aguarde o m√≥dulo autenticar.';
      });

      // Google buttons: if firebase module exposes functions, call them; else show message
      btnGoogleLogin.addEventListener('click', async () => {
        if (typeof window.firebaseSignInWithGoogle === 'function') {
          try { await window.firebaseSignInWithGoogle(); closeAuth(); }
          catch (err) { loginError.textContent = err.message || String(err); }
        } else {
          loginError.textContent = 'Login com Google necessita configura√ß√£o do Firebase.';
        }
      });
      btnGoogleSignup.addEventListener('click', async () => {
        if (typeof window.firebaseSignInWithGoogle === 'function') {
          try { await window.firebaseSignInWithGoogle(); closeAuth(); }
          catch (err) { signupError.textContent = err.message || String(err); }
        } else {
          signupError.textContent = 'Cadastro com Google necessita configura√ß√£o do Firebase.';
        }
      });

      // ====== TEAM BUILDER UI (one-by-one) ======
      const timeModal = $('#timeModal');
      const criarTimeBtn = $('#criarTimeBtn');
      const addPokemonBtn = $('#addPokemonBtn');
      const pokemonList = $('#pokemonList');
      const saveTimeBtn = $('#saveTimeBtn');
      const cancelTimeBtn = $('#cancelTimeBtn');
      const pokemonCountSpan = $('#pokemonCount');
      const STATS = ["HP","Atk","Def","SpA","SpD","Spe"];

      function updatePokemonCount() {
        pokemonCountSpan.textContent = String(pokemonList.children.length);
        addPokemonBtn.disabled = pokemonList.children.length >= 6;
      }

      function createPokemonCard(index){
        const wrapper = document.createElement('div');
        wrapper.className = 'poke-card-wrapper';
        const card = document.createElement('div');
        card.className = 'pokemon-card';

        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <h3>Pok√©mon ${index}</h3>
            <div><button class="btn-outline btn-remove">Remover</button></div>
          </div>

          <div class="row"><div class="label">Tier:</div><select class="tier"><option>OU</option><option>UU</option><option>NU</option><option>Uber</option></select></div>
          <div class="row"><div class="label">Nome:</div><input class="pokemonName" type="text" placeholder="Charizard"></div>
          <div class="row"><div class="label">Nature:</div><select class="nature"><option>Adamant</option><option>Modest</option><option>Jolly</option><option>Timid</option><option>Bold</option></select></div>
          <div class="row"><div class="label">Ability:</div><input class="ability" type="text" placeholder="Ability"></div>

          <div style="margin-top:8px"><div class="label" style="opacity:0.9;display:inline-block;width:110px">Moves:</div>
            <div style="display:inline-block;width:calc(100% - 120px)">
              <input class="move" type="text" placeholder="Move 1"><br>
              <input class="move" type="text" placeholder="Move 2"><br>
              <input class="move" type="text" placeholder="Move 3"><br>
              <input class="move" type="text" placeholder="Move 4"><br>
            </div>
          </div>

          <div style="margin-top:8px"><strong>IVs</strong></div>
          ${STATS.map(s => `<div class="stat"><label>${s}</label><input type="range" min="0" max="31" value="31" class="iv"><div class="val iv-val">31</div></div>`).join('')}

          <div style="margin-top:8px"><strong>EVs</strong></div>
          ${STATS.map(s => `<div class="stat"><label>${s}</label><input type="range" min="0" max="252" step="4" value="0" class="ev"><div class="val ev-val">0</div></div>`).join('')}

          <div class="progress"><div class="progress-bar"></div></div>
          <div class="ev-warning small"></div>
        `;

        wrapper.appendChild(card);

        // remove handler
        card.querySelector('.btn-remove').addEventListener('click', () => { wrapper.remove(); updatePokemonCount(); });

        // IV handlers
        const ivEls = card.querySelectorAll('.iv');
        ivEls.forEach((el, idx) => {
          el.addEventListener('input', (e) => {
            card.querySelectorAll('.iv-val')[idx].textContent = e.target.value;
          });
        });

        // EV handlers with constraints
        const evEls = Array.from(card.querySelectorAll('.ev'));
        evEls.forEach((el, idx) => {
          el.addEventListener('input', (e) => {
            // sanitize multiple of 4
            let want = Math.round((parseInt(e.target.value || 0)) / 4) * 4;
            if (want < 0) want = 0;
            if (want > 252) want = 252;
            const others = evEls.reduce((acc, el2, i2) => i2 === idx ? acc : acc + parseInt(el2.value || 0), 0);
            const remaining = 508 - others;
            if (want > remaining) want = Math.floor(remaining / 4) * 4;
            if (want < 0) want = 0;
            const count252 = evEls.filter((el2, i2) => i2 !== idx && parseInt(el2.value || 0) === 252).length;
            if (want === 252 && count252 >= 2) {
              want = Math.min(248, Math.floor(remaining / 4) * 4);
              if (want < 0) want = 0;
            }
            e.target.value = want;
            card.querySelectorAll('.ev-val')[idx].textContent = String(want);
            validateEVsAndBar(card);
          });
        });

        function validateEVsAndBar(cardEl){
          const evVals = Array.from(cardEl.querySelectorAll('.ev')).map(x => parseInt(x.value || 0));
          const total = evVals.reduce((a,b) => a + b, 0);
          const cnt252 = evVals.filter(v => v === 252).length;
          const warn = cardEl.querySelector('.ev-warning');
          const bar = cardEl.querySelector('.progress-bar');
          bar.style.width = `${Math.min(100, (total / 508) * 100)}%`;
          if (total > 508) warn.textContent = `‚ö† M√°x total 508 EVs (atual ${total})`;
          else if (cnt252 > 2) warn.textContent = `‚ö† M√°x 2 stats com 252 EVs`;
          else warn.textContent = '';
        }

        // init
        validateEVsAndBar(card);

        return wrapper;
      }

      addPokemonBtn.addEventListener('click', () => {
        if (pokemonList.children.length >= 6) { alert('M√°ximo 6 pok√©mons por time.'); return; }
        const node = createPokemonCard(pokemonList.children.length + 1);
        pokemonList.appendChild(node);
        updatePokemonCount();
      });

      updatePokemonCount();

      criarTimeBtn.addEventListener('click', () => {
        // the firebase module will check auth for saving; UI opens modal
        $('#timeModal').classList.add('open');
        $('#timeModal').style.display = 'flex';
      });
      cancelTimeBtn.addEventListener('click', () => {
        $('#timeModal').classList.remove('open');
        $('#timeModal').style.display = 'none';
      });
      // close when clicking outside modal content
      $('#timeModal').addEventListener('click', (e) => { if (e.target === $('#timeModal')) { $('#timeModal').classList.remove('open'); $('#timeModal').style.display = 'none'; } });

      // collect team function used by firebase module to save
      window.collectTeam = function(){
        const wrappers = Array.from(pokemonList.children);
        const arr = [];
        wrappers.forEach((w) => {
          const c = w.querySelector('.pokemon-card');
          const name = (c.querySelector('.pokemonName')?.value || '').trim();
          if (!name) return;
          const tier = c.querySelector('.tier').value;
          const nature = c.querySelector('.nature').value;
          const ability = (c.querySelector('.ability')?.value || '').trim();
          const moves = Array.from(c.querySelectorAll('.move')).map(m => m.value.trim()).filter(Boolean);
          const ivs = Object.fromEntries(Array.from(c.querySelectorAll('.iv')).map((el, i) => [STATS[i], el.value]));
          const evs = Object.fromEntries(Array.from(c.querySelectorAll('.ev')).map((el, i) => [STATS[i], el.value]));
          arr.push({ tier, name, nature, ability, moves, ivs, evs });
        });
        return arr;
      };

      // default: no firebase -> show friendly message on save
      saveTimeBtn.addEventListener('click', async () => {
        if (typeof window.firebaseSaveTeam === 'function') {
          try {
            await window.firebaseSaveTeam(window.collectTeam());
            alert('Time salvo com sucesso!');
            // clear UI
            pokemonList.innerHTML = '';
            updatePokemonCount();
            $('#timeModal').classList.remove('open'); $('#timeModal').style.display = 'none';
          } catch (err) {
            alert('Erro ao salvar time: ' + (err.message || String(err)));
          }
        } else {
          alert('Salvar time depende do Firebase; configure suas chaves para habilitar salvar no banco.');
        }
      });

    })();
  </script>

  <!-- ===== Firebase module (optional, runs if you replace keys) ===== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, signOut,
      createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, updateProfile
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getDatabase, ref, set, push, get, child, runTransaction, onValue
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ---------- PUT YOUR FIREBASE CONFIG HERE ----------
    const firebaseConfig = {
      apiKey: "FIREBASE_API_KEY",
      authDomain: "FIREBASE_AUTH_DOMAIN",
      databaseURL: "FIREBASE_DATABASE_URL",
      projectId: "FIREBASE_PROJECT_ID",
      storageBucket: "FIREBASE_STORAGE_BUCKET",
      messagingSenderId: "FIREBASE_MESSAGING_SENDER_ID",
      appId: "FIREBASE_APP_ID"
    };
    // If you left placeholders the UI will still work ‚Äî Firebase calls will fail with errors shown in console.

    let app, auth, db, provider;
    try {
      app = initializeApp(firebaseConfig);
      auth = getAuth(app);
      db = getDatabase(app);
      provider = new GoogleAuthProvider();
    } catch (err) {
      console.warn('Firebase init failed or config placeholders present:', err);
    }

    // Expose firebase-based functions to UI script:
    window.firebaseSignOut = async function(){
      if (!auth) throw new Error('Firebase n√£o configurado');
      await signOut(auth);
    };

    window.firebaseSignInWithGoogle = async function(){
      if (!auth) throw new Error('Firebase n√£o configurado');
      const result = await signInWithPopup(auth, provider);
      const user = result.user;
      // if new user: check if users/{uid} exists; else prompt for nick (we reuse auth modal UI)
      const snap = await get(child(ref(db), `users/${user.uid}`));
      if (!snap.exists()) {
        // ask for nick via UI: show auth modal signup tab with choose flow
        // For simplicity we'll reuse signup flow: open modal and require user to enter nick then click "Cadastrar"
        window.openAuth('signup');
        // prefill email? not required
        // Note: user is signed in; we require them to click "Cadastrar" to save nick-> users map.
        alert('Complete o cadastro escolhendo um nick √∫nico. Ap√≥s confirmar, seu perfil ser√° conclu√≠do.');
      } else {
        // user exists ‚Äî nothing else
        console.log('Google sign-in: user exists in DB');
      }
    };

    window.firebaseSaveTeam = async function(teamArr){
      if (!auth) throw new Error('Firebase n√£o configurado ou usu√°rio n√£o logado');
      if (!auth.currentUser) throw new Error('Usu√°rio n√£o est√° autenticado');
      if (!Array.isArray(teamArr) || teamArr.length === 0) throw new Error('Adicione pelo menos 1 Pok√©mon');
      // validate EV totals again server-side
      for (const p of teamArr){
        const evVals = Object.values(p.evs).map(v => parseInt(v || 0));
        const total = evVals.reduce((a,b)=>a+b,0);
        const cnt252 = evVals.filter(v=>v===252).length;
        if (total > 508) throw new Error(`Pok√©mon ${p.name} tem > 508 EVs`);
        if (cnt252 > 2) throw new Error(`Pok√©mon ${p.name} tem > 2 stats com 252 EVs`);
      }
      // push to /teams
      await push(ref(db, 'teams'), {
        ownerUid: auth.currentUser.uid,
        ownerEmail: auth.currentUser.email || null,
        pokemons: teamArr,
        createdAt: Date.now()
      });
    };

    // Helper: atomic claim nick using runTransaction
    async function claimNickAtomic(nick, uid) {
      if (!db) throw new Error('DB n√£o configurado');
      const nickRef = ref(db, `nicks/${nick}`);
      try {
        const res = await runTransaction(nickRef, (current) => {
          if (current === null) return uid;
          return; // abort
        });
        return res.committed === true;
      } catch (err) {
        console.error('runTransaction error', err);
        return false;
      }
    }

    // Signup with email: real behavior
    if (auth) {
      // attach handlers to forms (override the UI placeholders)
      document.getElementById('signupForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const nick = (document.getElementById('signupNick').value || '').trim();
        const email = (document.getElementById('signupEmail').value || '').trim();
        const pass = document.getElementById('signupPassword').value;
        const errBox = document.getElementById('signupError');
        errBox.textContent = '';
        if (!nick) return errBox.textContent = 'Nick obrigat√≥rio';
        if (!/^[A-Za-z0-9_]{3,20}$/.test(nick)) return errBox.textContent = 'Nick inv√°lido (3-20 alfanum/_).';
        try {
          // create user
          const cred = await createUserWithEmailAndPassword(auth, email, pass);
          const uid = cred.user.uid;
          // attempt atomic claim
          const ok = await claimNickAtomic(nick, uid);
          if (!ok) {
            // nickname exists; sign out user and ask to pick another
            try { await signOut(auth); } catch(e){}
            return errBox.textContent = 'Nick j√° em uso. Escolha outro nick.';
          }
          // save user profile in DB
          await set(ref(db, `users/${uid}`), { uid, email, provider: 'email', nick });
          // update displayName in auth profile
          try { await updateProfile(auth.currentUser, { displayName: nick }); } catch(e){}
          // close modal
          window.closeAuth();
        } catch (err) {
          console.error(err);
          errBox.textContent = err.message || 'Erro ao criar conta.';
        }
      });

      // login form actual submit
      document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = (document.getElementById('loginEmail').value || '').trim();
        const pass = document.getElementById('loginPassword').value;
        const errBox = document.getElementById('loginError');
        errBox.textContent = '';
        try {
          await signInWithEmailAndPassword(auth, email, pass);
          window.closeAuth();
        } catch (err) {
          console.error(err);
          errBox.textContent = err.message || 'Erro ao entrar';
        }
      });

      // Google sign-in handlers (both login and signup buttons call same)
      document.getElementById('btnGoogleLogin').addEventListener('click', async () => {
        try {
          await window.firebaseSignInWithGoogle();
        } catch (err) { $('#loginError').textContent = err.message || String(err); }
      });
      document.getElementById('btnGoogleSignup').addEventListener('click', async () => {
        try {
          await window.firebaseSignInWithGoogle();
        } catch (err) { $('#signupError').textContent = err.message || String(err); }
      });

      // update UI on auth change (do NOT replace click handlers)
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // try to load user profile (nick) from DB
          let display = user.displayName || user.email;
          try {
            const usnap = await get(child(ref(db), `users/${user.uid}`));
            if (usnap.exists() && usnap.val().nick) display = usnap.val().nick;
          } catch(e){}
          window.authState.loggedIn = true;
          window.authState.displayName = display;
          // Update login button label (without overriding its click handler)
          window.updateLoginButton();
          window.closeAuth();
        } else {
          window.authState.loggedIn = false;
          window.authState.displayName = null;
          window.updateLoginButton();
        }
      });

      // expose firebaseSignInWithGoogle to UI script
      window.firebaseSignInWithGoogle = async function(){
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        // check if user has DB profile
        const userSnap = await get(child(ref(db), `users/${user.uid}`));
        if (!userSnap.exists()) {
          // ask user to choose a nick: open signup tab
          window.openAuth('signup');
          alert('Selecione um nick √∫nico para terminar o cadastro (ap√≥s escolher, clique em "Cadastrar").');
        }
      };

    } // end if auth ready

    // LIST teams to page (simple)
    try {
      if (db) {
        const container = document.getElementById('timesContainer');
        onValue(ref(db, 'teams'), (snap) => {
          container.innerHTML = '';
          snap.forEach(childSnap => {
            const time = childSnap.val();
            const div = document.createElement('div');
            div.className = 'time-card';
            // try to show owner's nick (non-blocking)
            get(child(ref(db), `users/${time.ownerUid}`)).then(usnap => {
              const owner = (usnap.exists() && usnap.val().nick) ? usnap.val().nick : (time.ownerEmail || 'Usu√°rio');
              div.innerHTML = `<h3>Time de ${owner}</h3><pre style="white-space:pre-wrap;word-break:break-word">${JSON.stringify(time.pokemons, null, 2)}</pre>`;
            }).catch(() => {
              div.innerHTML = `<h3>Time</h3><pre style="white-space:pre-wrap;word-break:break-word">${JSON.stringify(time.pokemons, null, 2)}</pre>`;
            });
            container.appendChild(div);
          });
        });
      }
    } catch (err) {
      console.warn('Could not attach teams listener (firebase not configured).', err);
    }

    // helper to get DOM quickly inside module
    function $(s){ return document.querySelector(s); }

  </script>
</body>
</html>
